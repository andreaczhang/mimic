{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {
    "collapsed": false
   },
   "outputs": [],
   "source": [
    "from __future__ import print_function\n",
    "\n",
    "# Import libraries\n",
    "import numpy as np\n",
    "import pandas as pd\n",
    "import sklearn\n",
    "import psycopg2\n",
    "import sys\n",
    "import datetime as dt\n",
    "import mp_utils as mp\n",
    "\n",
    "# to display dataframes in notebooks\n",
    "from IPython.display import display, HTML\n",
    "\n",
    "from collections import OrderedDict\n",
    "\n",
    "# used to print out pretty pandas dataframes\n",
    "from IPython.display import display, HTML\n",
    "\n",
    "from sklearn.pipeline import Pipeline\n",
    "\n",
    "# used to impute mean for data and standardize for computational stability\n",
    "from sklearn.preprocessing import Imputer\n",
    "from sklearn.preprocessing import StandardScaler\n",
    "\n",
    "# logistic regression is our favourite model ever\n",
    "from sklearn.linear_model import LogisticRegression\n",
    "from sklearn.linear_model import LogisticRegressionCV # l2 regularized regression\n",
    "from sklearn.linear_model import LassoCV\n",
    "from sklearn.ensemble import RandomForestClassifier\n",
    "\n",
    "# used to calculate AUROC/accuracy\n",
    "from sklearn import metrics\n",
    "\n",
    "# gradient boosting - must download package https://github.com/dmlc/xgboost\n",
    "import xgboost as xgb\n",
    "\n",
    "#import matplotlib\n",
    "#import matplotlib.pyplot as plt\n",
    "#from matplotlib.font_manager import FontProperties # for unicode fonts\n",
    "#%matplotlib inline\n",
    "\n",
    "# below config used on pc70\n",
    "sqluser = 'alistairewj'\n",
    "dbname = 'mimic'\n",
    "schema_name = 'mimiciii'\n",
    "query_schema = 'SET search_path to public,' + schema_name + ';'\n",
    "\n",
    "\n",
    "# two options for loading data\n",
    "# option 1) use SQL - requires database and to have run queries/make_all.sql\n",
    "# option 2) use CSVs downloaded\n",
    "USE_SQL=1\n",
    "USE_CSV=0"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {
    "collapsed": false
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "(6386894, 54)\n"
     ]
    }
   ],
   "source": [
    "if USE_SQL:\n",
    "    # Connect to local postgres version of mimic\n",
    "    con = psycopg2.connect(dbname=dbname, user=sqluser)\n",
    "\n",
    "    # exclusion criteria:\n",
    "    #   - less than 15 years old\n",
    "    #   - stayed in the ICU less than 4 hours\n",
    "    #   - never have any chartevents data (i.e. likely administrative error)\n",
    "    #   - organ donor accounts (administrative \"readmissions\" for patients who died in hospital)\n",
    "    query = query_schema + \\\n",
    "    \"\"\"\n",
    "    select \n",
    "        *\n",
    "    from dm_cohort\n",
    "    \"\"\"\n",
    "    co = pd.read_sql_query(query,con)\n",
    "    \n",
    "    # convert the inclusion flags to boolean\n",
    "    for c in co.columns:\n",
    "        if c[0:10]=='inclusion_':\n",
    "            co[c] = co[c].astype(bool)\n",
    "\n",
    "    # extract static vars into a separate dataframe\n",
    "    df_static = pd.read_sql_query(query_schema + 'select * from mp_static_data', con)\n",
    "    #for dtvar in ['intime','outtime','deathtime']:\n",
    "    #    df_static[dtvar] = pd.to_datetime(df_static[dtvar])\n",
    "\n",
    "    vars_static = [u'is_male', u'emergency_admission', u'age',\n",
    "                   # services\n",
    "                   u'service_any_noncard_surg',\n",
    "                   u'service_any_card_surg',\n",
    "                   u'service_cmed',\n",
    "                   u'service_traum',\n",
    "                   u'service_nmed',\n",
    "                   # ethnicities\n",
    "                   u'race_black',u'race_hispanic',u'race_asian',u'race_other',\n",
    "                   # phatness\n",
    "                   u'height', u'weight', u'bmi']\n",
    "\n",
    "\n",
    "    # get ~5 million rows containing data from errbody\n",
    "    # this takes a little bit of time to load into memory (~2 minutes)\n",
    "\n",
    "    # %%time results\n",
    "    # CPU times: user 42.8 s, sys: 1min 3s, total: 1min 46s\n",
    "    # Wall time: 2min 7s\n",
    "\n",
    "    df = pd.read_sql_query(query_schema + 'select * from mp_data', con)\n",
    "    df.drop('subject_id',axis=1,inplace=True)\n",
    "    df.drop('hadm_id',axis=1,inplace=True)\n",
    "    df.sort_values(['icustay_id','hr'],axis=0,ascending=True,inplace=True)\n",
    "\n",
    "    # get death information\n",
    "    df_death = pd.read_sql_query(query_schema + \"\"\"\n",
    "    select \n",
    "    co.subject_id, co.hadm_id, co.icustay_id\n",
    "    , ceil(extract(epoch from (co.outtime - co.intime))/60.0/60.0) as dischtime_hours\n",
    "    , ceil(extract(epoch from (adm.deathtime - co.intime))/60.0/60.0) as deathtime_hours\n",
    "    , case when adm.deathtime is null then 0 else 1 end as death\n",
    "    from dm_cohort co\n",
    "    inner join admissions adm\n",
    "    on co.hadm_id = adm.hadm_id\n",
    "    where co.excluded = 0\n",
    "    \"\"\", con)\n",
    "    \n",
    "    # get censoring information\n",
    "    df_censor = pd.read_sql_query(query_schema + \"\"\"\n",
    "    select co.icustay_id, min(cs.charttime) as censortime\n",
    "    , ceil(extract(epoch from min(cs.charttime-co.intime) )/60.0/60.0) as censortime_hours\n",
    "    from dm_cohort co \n",
    "    inner join mp_code_status cs\n",
    "    on co.icustay_id = cs.icustay_id\n",
    "    where cmo+dnr+dni+dncpr+cmo_notes>0\n",
    "    and co.excluded = 0\n",
    "    group by co.icustay_id\n",
    "    \"\"\", con)\n",
    "    \n",
    "    # extract static vars into a separate dataframe\n",
    "    df_static = pd.read_sql_query(query_schema + 'select * from mp_static_data', con)\n",
    "    \n",
    "elif USE_CSV:\n",
    "    co = pd.read_csv('df_cohort.csv.gz')\n",
    "    \n",
    "    # convert the inclusion flags to boolean\n",
    "    for c in co.columns:\n",
    "        if c[0:10]=='inclusion_':\n",
    "            co[c] = co[c].astype(bool)\n",
    "    df = pd.read_csv('df_data.csv.gz')\n",
    "    df_static = pd.read_csv('df_static_data.csv.gz')\n",
    "    df_censor = pd.read_csv('df_censor.csv.gz')\n",
    "    df_death = pd.read_csv('df_death.csv.gz')\n",
    "    \n",
    "else:\n",
    "    print('Must use SQL or CSV to load data!')\n",
    "    \n",
    "    \n",
    "print(df.shape)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Base exclusion criteria"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {
    "collapsed": false
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Cohort - initial size: 61532 ICU stays\n",
      "   8101 (13.17%) - exclusion_over_15\n",
      "   1347 (2.19%) - exclusion_valid_data\n",
      "   3641 (5.92%) - exclusion_stay_lt_4hr\n",
      "      4 (0.01%) - exclusion_organ_donor\n",
      "   9447 (15.35%) - all exclusions\n",
      "\n",
      "Final cohort size: 52085 ICU stays (84.65%).\n"
     ]
    }
   ],
   "source": [
    "# print out the exclusions *SEQUENTIALLY* - i.e. if already excluded, don't re-print\n",
    "print('Cohort - initial size: {} ICU stays'.format(co.shape[0]))\n",
    "\n",
    "idxRem = np.zeros(co.shape[0],dtype=bool)\n",
    "for c in co.columns:\n",
    "    if c[0:len('exclusion_')]=='exclusion_':\n",
    "        N_REM = np.sum( (co[c].values==1) )\n",
    "        print('  {:5g} ({:2.2f}%) - {}'.format(N_REM,N_REM*100.0/co.shape[0], c))\n",
    "        idxRem[co[c].values==1] = True\n",
    "\n",
    "# summarize all exclusions\n",
    "N_REM = np.sum( idxRem )\n",
    "print('  {:5g} ({:2.2f}%) - {}'.format(N_REM,N_REM*100.0/co.shape[0], 'all exclusions'))\n",
    "print('')\n",
    "print('Final cohort size: {} ICU stays ({:2.2f}%).'.format(co.shape[0] - np.sum(idxRem), (1-np.mean(idxRem))*100.0))\n",
    "co = co.loc[~idxRem,:]"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Mortality stats\n",
    "\n",
    "### Mortality in base cohort"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {
    "collapsed": false
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "death_48hr_post_icu_admit                1614 of 52085 died (3.10%).\n",
      "death_icu                                4185 of 52085 died (8.03%).\n",
      "death_in_hospital                        6192 of 52085 died (11.89%).\n",
      "death_30dy_post_icu_admit                7567 of 52085 died (14.53%).\n",
      "death_30dy_post_icu_disch                8081 of 52085 died (15.52%).\n",
      "death_30dy_post_hos_disch                8633 of 52085 died (16.57%).\n",
      "death_6mo_post_hos_disch                12788 of 52085 died (24.55%).\n",
      "death_1yr_post_hos_disch                15052 of 52085 died (28.90%).\n",
      "death_2yr_post_hos_disch                15052 of 52085 died (28.90%).\n",
      "death_30dy_post_hos_admit                7124 of 52085 died (13.68%).\n"
     ]
    }
   ],
   "source": [
    "# mortality stats for base cohort\n",
    "for c in co.columns:\n",
    "    if c[0:len('death_')]=='death_':\n",
    "        N_ALL = co.shape[0]\n",
    "        N = co.set_index('icustay_id').loc[:,c].sum()\n",
    "        print('{:40s}{:5g} of {:5g} died ({:2.2f}%).'.format(c, N, N_ALL, N*100.0/N_ALL))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Mortality in MIMIC-II patients staying >= 24 hours\n",
    "\n",
    "This is mainly an example of how the `inclFcn` works. It derives from the cohort a boolean index of patients to retain in the dataset."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {
    "collapsed": false
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "death_48hr_post_icu_admit                 405 of 23497 died (1.72%).\n",
      "death_icu                                2020 of 23497 died (8.60%).\n",
      "death_in_hospital                        3034 of 23497 died (12.91%).\n",
      "death_30dy_post_icu_admit                3613 of 23497 died (15.38%).\n",
      "death_30dy_post_icu_disch                3933 of 23497 died (16.74%).\n",
      "death_30dy_post_hos_disch                4212 of 23497 died (17.93%).\n",
      "death_6mo_post_hos_disch                 6205 of 23497 died (26.41%).\n",
      "death_1yr_post_hos_disch                 7362 of 23497 died (31.33%).\n",
      "death_2yr_post_hos_disch                 7362 of 23497 died (31.33%).\n",
      "death_30dy_post_hos_admit                3390 of 23497 died (14.43%).\n"
     ]
    }
   ],
   "source": [
    "inclFcn = lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_stay_ge_24hr'],'icustay_id']\n",
    "\n",
    "# mortality stats for base cohort\n",
    "for c in co.columns:\n",
    "    if c[0:len('death_')]=='death_':\n",
    "        N_ALL = inclFcn(co).shape[0]\n",
    "        N = co.set_index('icustay_id').loc[inclFcn(co),c].sum()\n",
    "        print('{:40s}{:5g} of {:5g} died ({:2.2f}%).'.format(c, N, N_ALL, N*100.0/N_ALL))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Here we have the same function in a slightly more obscure way - with the benefit of being able to list all inclusions in a list. This just helps readability in the below code."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {
    "collapsed": false
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "death_48hr_post_icu_admit                 405 of 23497 died (1.72%).\n",
      "death_icu                                2020 of 23497 died (8.60%).\n",
      "death_in_hospital                        3034 of 23497 died (12.91%).\n",
      "death_30dy_post_icu_admit                3613 of 23497 died (15.38%).\n",
      "death_30dy_post_icu_disch                3933 of 23497 died (16.74%).\n",
      "death_30dy_post_hos_disch                4212 of 23497 died (17.93%).\n",
      "death_6mo_post_hos_disch                 6205 of 23497 died (26.41%).\n",
      "death_1yr_post_hos_disch                 7362 of 23497 died (31.33%).\n",
      "death_2yr_post_hos_disch                 7362 of 23497 died (31.33%).\n",
      "death_30dy_post_hos_admit                3390 of 23497 died (14.43%).\n"
     ]
    }
   ],
   "source": [
    "inclusions = ['inclusion_only_mimicii', 'inclusion_stay_ge_24hr']\n",
    "inclFcn = lambda x: x.loc[x[inclusions].all(axis=1),'icustay_id']\n",
    "\n",
    "# mortality stats for base cohort\n",
    "for c in co.columns:\n",
    "    if c[0:len('death_')]=='death_':\n",
    "        N_ALL = inclFcn(co).shape[0]\n",
    "        N = co.set_index('icustay_id').loc[inclFcn(co),c].sum()\n",
    "        print('{:40s}{:5g} of {:5g} died ({:2.2f}%).'.format(c, N, N_ALL, N*100.0/N_ALL))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Exclusion criteria\n",
    "\n",
    "Each study has its own exclusion criteria (sometimes studies have multiple experiments). We define a dictionary of all exclusions with the dictionary key as the study name. Some studies have multiple experiments, so we append *a*, *b*, or *c*.\n",
    "\n",
    "The dictionary stores a length 2 list. The first element defines the window for data extraction: it contains a dictionary of the windows and the corresponding window sizes. The second element is the exclusion criteria. Both are functions which use `co` or `df` as their input."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {
    "collapsed": false
   },
   "outputs": [],
   "source": [
    "# first we can define the different windows: there aren't that many!\n",
    "df_tmp=co.copy().set_index('icustay_id')\n",
    "\n",
    "# admission+12 hours\n",
    "time_12hr = df_tmp.copy()\n",
    "time_12hr['windowtime'] = 12\n",
    "time_12hr = time_12hr['windowtime'].to_dict()\n",
    "\n",
    "# admission+24 hours\n",
    "time_24hr = df_tmp.copy()\n",
    "time_24hr['windowtime'] = 24\n",
    "time_24hr = time_24hr['windowtime'].to_dict()\n",
    "\n",
    "# admission+48 hours\n",
    "time_48hr = df_tmp.copy()\n",
    "time_48hr['windowtime'] = 48\n",
    "time_48hr = time_48hr['windowtime'].to_dict()\n",
    "\n",
    "# admission+72 hours\n",
    "time_72hr = df_tmp.copy()\n",
    "time_72hr['windowtime'] = 72\n",
    "time_72hr = time_72hr['windowtime'].to_dict()\n",
    "\n",
    "# admission+96 hours\n",
    "time_96hr = df_tmp.copy()\n",
    "time_96hr['windowtime'] = 96\n",
    "time_96hr = time_96hr['windowtime'].to_dict()\n",
    "\n",
    "# entire stay\n",
    "time_all = df_tmp.copy()\n",
    "time_all = time_all['dischtime_hours'].apply(np.ceil).astype(int).to_dict()\n",
    "\n",
    "# 12 hours before the patient died/discharged\n",
    "time_predeath = df_tmp.copy()\n",
    "time_predeath['windowtime'] = time_predeath['dischtime_hours']\n",
    "idx = time_predeath['deathtime_hours']<time_predeath['dischtime_hours']\n",
    "time_predeath.loc[idx,'windowtime'] = time_predeath.loc[idx,'deathtime_hours']\n",
    "# move from discharge/death time to 12 hours beforehand\n",
    "time_predeath['windowtime'] = time_predeath['windowtime']-12\n",
    "time_predeath = time_predeath['windowtime'].apply(np.ceil).astype(int).to_dict()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {
    "collapsed": false
   },
   "outputs": [],
   "source": [
    "# example params used to extract patient data\n",
    "# element 1: dictionary specifying end time of window for each patient\n",
    "# element 2: size of window\n",
    "# element 3: extra hours added to make it easier to get data on labs (and allows us to get labs pre-ICU)\n",
    "# e.g. [time_24hr, 8, 24] is\n",
    "#   (1) window ends at admission+24hr\n",
    "#   (2) window is 8 hours long\n",
    "#   (3) lab window is 8+24=32 hours long\n",
    "\n",
    "def inclFcn(x, inclusions):\n",
    "    return x.loc[x[inclusions].all(axis=1),'icustay_id']\n",
    "\n",
    "\n",
    "# this one is used more than once, so we define it here\n",
    "hugExclFcnMIMIC3 = lambda x: x.loc[x['inclusion_over_18']&x['inclusion_hug2009_obs']&x['inclusion_hug2009_not_nsicu_csicu']&x['inclusion_first_admission']&x['inclusion_full_code']&x['inclusion_not_brain_death']&x['inclusion_not_crf'],'icustay_id'].values\n",
    "hugExclFcn = lambda x: np.intersect1d(hugExclFcnMIMIC3(x),x.loc[x['inclusion_only_mimicii'],'icustay_id'].values)\n",
    "\n",
    "\n",
    "# physionet2012 subset - not exact but close\n",
    "def physChallExclFcn(x):\n",
    "    out = x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_stay_ge_48hr']&x['inclusion_has_saps'],'icustay_id'].values\n",
    "    out = np.sort(out)\n",
    "    out = out[0:4000]\n",
    "    return out\n",
    " \n",
    "# caballero2015 is a random subsample - then limits to 18yrs, resulting in 11648\n",
    "def caballeroExclFcn(x):\n",
    "    out = x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18'],'icustay_id'].values\n",
    "    out = np.sort(out)\n",
    "    out = out[0:11648]\n",
    "    return out\n",
    "\n",
    "np.random.seed(546345)\n",
    "W_extra = 24\n",
    "\n",
    "exclusions = OrderedDict([\n",
    "['caballero2015dynamically_a',  [[time_24hr, 24, W_extra], caballeroExclFcn, 'hospital_expire_flag']],\n",
    "['caballero2015dynamically_b',  [[time_48hr, 48, W_extra], caballeroExclFcn, 'hospital_expire_flag']],\n",
    "['caballero2015dynamically_c',  [[time_72hr, 72, W_extra], caballeroExclFcn, 'hospital_expire_flag']],\n",
    "['calvert2016computational',    [[time_predeath, 5, W_extra], lambda x: x.loc[x['inclusion_over_18']&x['inclusion_only_micu']&x['inclusion_calvert2016_obs']&x['inclusion_stay_ge_17hr']&x['inclusion_stay_le_500hr']&x['inclusion_non_alc_icd9'],'icustay_id'].values, 'hospital_expire_flag']],\n",
    "['calvert2016using',            [[time_predeath, 5, W_extra], lambda x: x.loc[x['inclusion_over_18']&x['inclusion_only_micu']&x['inclusion_calvert2016_obs']&x['inclusion_stay_ge_17hr']&x['inclusion_stay_le_500hr'],'icustay_id'].values, 'hospital_expire_flag']],\n",
    "['celi2012database_a',          [[time_72hr, 72, W_extra], lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_aki_icd9'],'icustay_id'].values , 'hospital_expire_flag']],\n",
    "['celi2012database_b',          [[time_24hr, 24, W_extra], lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_sah_icd9'],'icustay_id'].values , 'hospital_expire_flag']],\n",
    "['che2016recurrent_a',          [[time_48hr, 48, W_extra], lambda x: x.loc[x['inclusion_over_18'],'icustay_id'].values , 'death_48hr_post_icu_admit']],\n",
    "['che2016recurrent_b',          [[time_48hr, 48, W_extra], physChallExclFcn , 'hospital_expire_flag']],\n",
    "['ding2016mortality',           [[time_48hr, 48, W_extra], physChallExclFcn , 'hospital_expire_flag']],\n",
    "['ghassemi2014unfolding_a',     [[time_24hr, 24, W_extra], lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_ge_100_non_stop_words']&x['inclusion_stay_ge_24hr'],'icustay_id'].values, 'hospital_expire_flag']],\n",
    "['ghassemi2014unfolding_b',     [[time_12hr, 12, W_extra], lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_ge_100_non_stop_words']&x['inclusion_stay_ge_12hr'],'icustay_id'].values, 'hospital_expire_flag']],\n",
    "['ghassemi2014unfolding_c',     [[time_12hr, 12, W_extra], lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_ge_100_non_stop_words']&x['inclusion_stay_ge_12hr'],'icustay_id'].values, 'death_30dy_post_hos_disch']],\n",
    "['ghassemi2014unfolding_d',     [[time_12hr, 12, W_extra], lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_ge_100_non_stop_words']&x['inclusion_stay_ge_12hr'],'icustay_id'].values, 'death_1yr_post_hos_disch']],\n",
    "['ghassemi2015multivariate_a',    [[time_24hr, 24, W_extra], lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_ge_100_non_stop_words']&x['inclusion_gt_6_notes']&x['inclusion_stay_ge_24hr']&x['inclusion_has_saps'],'icustay_id'].values, 'hospital_expire_flag']],\n",
    "['ghassemi2015multivariate_b',    [[time_24hr, 24, W_extra], lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_ge_100_non_stop_words']&x['inclusion_gt_6_notes']&x['inclusion_stay_ge_24hr']&x['inclusion_has_saps'],'icustay_id'].values, 'death_1yr_post_hos_disch']],\n",
    "['grnarova2016neural_a',          [[time_all,  24, W_extra], lambda x: x.loc[x['inclusion_over_18']&x['inclusion_multiple_hadm'],'icustay_id'].values, 'hospital_expire_flag']],\n",
    "['grnarova2016neural_b',          [[time_all,  24, W_extra], lambda x: x.loc[x['inclusion_over_18']&x['inclusion_multiple_hadm'],'icustay_id'].values, 'death_30dy_post_hos_disch']],\n",
    "['grnarova2016neural_c',          [[time_all,  24, W_extra], lambda x: x.loc[x['inclusion_over_18']&x['inclusion_multiple_hadm'],'icustay_id'].values, 'death_1yr_post_hos_disch']],\n",
    "['harutyunyan2017multitask',    [[time_48hr, 48, W_extra], lambda x: x.loc[x['inclusion_over_18']&x['inclusion_multiple_icustay'],'icustay_id'].values, 'hospital_expire_flag']],\n",
    "['hoogendoorn2016prediction',   [[time_24hr, 24, W_extra], lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_hug2009_obs']&x['inclusion_stay_ge_24hr'],'icustay_id'].values, 'hospital_expire_flag']],\n",
    "['hug2009icu',                  [[time_24hr, 24, W_extra], hugExclFcn, 'death_30dy_post_icu_disch']],\n",
    "['johnson2012patient',          [[time_48hr, 48, W_extra], physChallExclFcn, 'hospital_expire_flag']],\n",
    "['johnson2014data',             [[time_48hr, 48, W_extra], physChallExclFcn, 'hospital_expire_flag']],\n",
    "['joshi2012prognostic',         [[time_24hr, 24, W_extra], hugExclFcn, 'hospital_expire_flag']],\n",
    "['joshi2016identifiable',       [[time_48hr, 48, W_extra], lambda x: x.loc[x['inclusion_over_18']&x['inclusion_stay_ge_48hr'],'icustay_id'].values, 'hospital_expire_flag']],\n",
    "['lee2015customization_a',        [[time_24hr, 24, W_extra], lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_lee2015_service']&x['inclusion_has_saps']&x['inclusion_stay_ge_24hr'],'icustay_id'].values, 'hospital_expire_flag']],\n",
    "['lee2015customization_b',        [[time_24hr, 24, W_extra], lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_lee2015_service']&x['inclusion_has_saps']&x['inclusion_stay_ge_24hr'],'icustay_id'].values, 'death_30dy_post_hos_disch']],\n",
    "['lee2015customization_c',        [[time_24hr, 24, W_extra], lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_lee2015_service']&x['inclusion_has_saps']&x['inclusion_stay_ge_24hr'],'icustay_id'].values, 'death_2yr_post_hos_disch']],\n",
    "['lee2015personalized',         [[time_24hr, 24, W_extra], lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_has_saps']&x['inclusion_stay_ge_24hr'],'icustay_id'].values, 'death_30dy_post_hos_disch']],\n",
    "['lee2017patient',              [[time_24hr, 24, W_extra], lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_has_saps']&x['inclusion_stay_ge_24hr'],'icustay_id'].values, 'death_30dy_post_hos_disch']],\n",
    "['lehman2012risk',              [[time_24hr, 24, W_extra], lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_has_saps']&x['inclusion_stay_ge_24hr']&x['inclusion_first_admission'],'icustay_id'].values, 'hospital_expire_flag']],\n",
    "['luo2016interpretable_a',        [[time_all,  24, W_extra], lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_has_sapsii']&x['inclusion_no_disch_summary'],'icustay_id'].values, 'death_30dy_post_hos_disch']],\n",
    "['luo2016interpretable_b',        [[time_all,  24, W_extra], lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_has_sapsii']&x['inclusion_no_disch_summary'],'icustay_id'].values, 'death_6mo_post_hos_disch']],\n",
    "['luo2016predicting',           [[time_24hr, 12, W_extra], lambda x: np.intersect1d(hugExclFcn(x),x.loc[x['inclusion_stay_ge_24hr'],'icustay_id'].values) , 'death_30dy_post_icu_disch']],\n",
    "['pirracchio2015mortality',     [[time_24hr, 24, W_extra], lambda x: x.loc[x['inclusion_only_mimicii'],'icustay_id'].values , 'hospital_expire_flag']],\n",
    "['ripoll2014sepsis',            [[time_24hr, 24, W_extra], lambda x: x.loc[x['inclusion_only_mimicii']&x['inclusion_over_18']&x['inclusion_has_saps']&x['inclusion_not_explicit_sepsis'],'icustay_id'].values, 'hospital_expire_flag']],\n",
    "['wojtusiak2017c',              [[time_all,  24, W_extra], lambda x: x.loc[x['inclusion_over_65']&x['inclusion_alive_hos_disch'],'icustay_id'].values, 'death_30dy_post_hos_disch']]\n",
    "])"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Compare sample sizes and mortality rates"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {
    "collapsed": false
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "11648 (22.36%) - Mortality = 13.01% - caballero2015dynamically_a\n",
      "11648 (22.36%) - Mortality = 13.01% - caballero2015dynamically_b\n",
      "11648 (22.36%) - Mortality = 13.01% - caballero2015dynamically_c\n",
      " 1985 ( 3.81%) - Mortality = 13.80% - calvert2016computational\n",
      "18396 (35.32%) - Mortality = 14.71% - calvert2016using\n",
      " 4741 ( 9.10%) - Mortality = 23.92% - celi2012database_a\n",
      " 1070 ( 2.05%) - Mortality = 19.16% - celi2012database_b\n",
      "51986 (99.81%) - Mortality =  3.10% - che2016recurrent_a\n",
      " 4000 ( 7.68%) - Mortality = 14.35% - che2016recurrent_b\n",
      " 4000 ( 7.68%) - Mortality = 14.35% - ding2016mortality\n",
      "23442 (45.01%) - Mortality = 12.92% - ghassemi2014unfolding_a\n",
      "28172 (54.09%) - Mortality = 12.20% - ghassemi2014unfolding_b\n",
      "28172 (54.09%) - Mortality = 16.92% - ghassemi2014unfolding_c\n",
      "28172 (54.09%) - Mortality = 29.75% - ghassemi2014unfolding_d\n",
      "21969 (42.18%) - Mortality = 13.51% - ghassemi2015multivariate_a\n",
      "21969 (42.18%) - Mortality = 32.35% - ghassemi2015multivariate_b\n",
      "29572 (56.78%) - Mortality = 12.49% - grnarova2016neural_a\n",
      "29572 (56.78%) - Mortality = 16.36% - grnarova2016neural_b\n",
      "29572 (56.78%) - Mortality = 24.63% - grnarova2016neural_c\n",
      "45493 (87.34%) - Mortality = 10.54% - harutyunyan2017multitask\n",
      "17545 (33.69%) - Mortality = 14.97% - hoogendoorn2016prediction\n",
      "10696 (20.54%) - Mortality =  6.35% - hug2009icu\n",
      " 4000 ( 7.68%) - Mortality = 14.35% - johnson2012patient\n",
      " 4000 ( 7.68%) - Mortality = 14.35% - johnson2014data\n",
      "10696 (20.54%) - Mortality =  4.14% - joshi2012prognostic\n",
      "26508 (50.89%) - Mortality = 14.95% - joshi2016identifiable\n",
      "20961 (40.24%) - Mortality = 12.69% - lee2015customization_a\n",
      "20961 (40.24%) - Mortality = 17.86% - lee2015customization_b\n",
      "20961 (40.24%) - Mortality = 31.57% - lee2015customization_c\n",
      "23443 (45.01%) - Mortality = 17.94% - lee2015personalized\n",
      "23443 (45.01%) - Mortality = 17.94% - lee2017patient\n",
      "21738 (41.74%) - Mortality = 12.32% - lehman2012risk\n",
      "27747 (53.27%) - Mortality = 17.05% - luo2016interpretable_a\n",
      "27747 (53.27%) - Mortality = 25.17% - luo2016interpretable_b\n",
      " 8931 (17.15%) - Mortality =  6.45% - luo2016predicting\n",
      "28795 (55.28%) - Mortality = 12.72% - pirracchio2015mortality\n",
      " 2251 ( 4.32%) - Mortality = 39.63% - ripoll2014sepsis\n",
      "22699 (43.58%) - Mortality =  7.74% - wojtusiak2017c\n"
     ]
    }
   ],
   "source": [
    "repro_stats = pd.DataFrame(None, columns=['N_Repro','Y_Repro'])\n",
    "\n",
    "N = co.shape[0]\n",
    "    \n",
    "for current_study in exclusions:\n",
    "    params, iid_keep, y_outcome_label = exclusions[current_study]\n",
    "    \n",
    "    # iid_keep is currently a function - apply it to co to get ICUSTAY_IDs to keep for this study\n",
    "    iid_keep = iid_keep(co)\n",
    "    \n",
    "    N_STUDY = iid_keep.shape[0]\n",
    "    Y_STUDY = co.set_index('icustay_id').loc[iid_keep,y_outcome_label].mean()*100.0\n",
    "    \n",
    "    # print size of cohort in study\n",
    "    print('{:5g} ({:5.2f}%) - Mortality = {:5.2f}% - {}'.format(\n",
    "            N_STUDY, N_STUDY*100.0/N, Y_STUDY,\n",
    "            current_study)\n",
    "         )\n",
    "    \n",
    "    repro_stats.loc[current_study] = [N_STUDY, Y_STUDY]\n",
    "    "
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "With the above dataframe, `repro_stats`, we can compare our results to those extracted manually from the studies. We load in the manual extraction from the `data` subfolder, merge it with this dataframe, and output to CSV."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {
    "collapsed": false
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style>\n",
       "    .dataframe thead tr:only-child th {\n",
       "        text-align: right;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: left;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>N_Study</th>\n",
       "      <th>N_Repro</th>\n",
       "      <th>Y_Study</th>\n",
       "      <th>Y_Repro</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Cohort</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>caballero2015dynamically_a</th>\n",
       "      <td>11648</td>\n",
       "      <td>11648.0</td>\n",
       "      <td>-</td>\n",
       "      <td>13.006525</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>caballero2015dynamically_b</th>\n",
       "      <td>11648</td>\n",
       "      <td>11648.0</td>\n",
       "      <td>-</td>\n",
       "      <td>13.006525</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>caballero2015dynamically_c</th>\n",
       "      <td>11648</td>\n",
       "      <td>11648.0</td>\n",
       "      <td>-</td>\n",
       "      <td>13.006525</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>calvert2016computational</th>\n",
       "      <td>3054</td>\n",
       "      <td>1985.0</td>\n",
       "      <td>12.84</td>\n",
       "      <td>13.803526</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>calvert2016using</th>\n",
       "      <td>9683</td>\n",
       "      <td>18396.0</td>\n",
       "      <td>10.68</td>\n",
       "      <td>14.709720</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>celi2012database_a</th>\n",
       "      <td>1400</td>\n",
       "      <td>4741.0</td>\n",
       "      <td>30.7</td>\n",
       "      <td>23.919004</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>celi2012database_b</th>\n",
       "      <td>223</td>\n",
       "      <td>1070.0</td>\n",
       "      <td>25.6</td>\n",
       "      <td>19.158879</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>che2016recurrent_a</th>\n",
       "      <td>4000</td>\n",
       "      <td>51986.0</td>\n",
       "      <td>13.85</td>\n",
       "      <td>3.095064</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ding2016mortality</th>\n",
       "      <td>4000</td>\n",
       "      <td>4000.0</td>\n",
       "      <td>13.85</td>\n",
       "      <td>14.350000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ghassemi2014unfolding_a</th>\n",
       "      <td>19308</td>\n",
       "      <td>23442.0</td>\n",
       "      <td>10.84</td>\n",
       "      <td>12.916987</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ghassemi2014unfolding_b</th>\n",
       "      <td>19308</td>\n",
       "      <td>28172.0</td>\n",
       "      <td>10.80</td>\n",
       "      <td>12.200057</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ghassemi2015multivariate_a</th>\n",
       "      <td>10202</td>\n",
       "      <td>21969.0</td>\n",
       "      <td>-</td>\n",
       "      <td>13.514498</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>grnarova2016neural_a</th>\n",
       "      <td>31244</td>\n",
       "      <td>29572.0</td>\n",
       "      <td>13.82</td>\n",
       "      <td>12.494928</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>harutyunyan2017multitask</th>\n",
       "      <td>42276</td>\n",
       "      <td>45493.0</td>\n",
       "      <td>-</td>\n",
       "      <td>10.535687</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>hoogendoorn2016prediction</th>\n",
       "      <td>13923</td>\n",
       "      <td>17545.0</td>\n",
       "      <td>-</td>\n",
       "      <td>14.967227</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>johnson2012patient</th>\n",
       "      <td>4000</td>\n",
       "      <td>4000.0</td>\n",
       "      <td>-</td>\n",
       "      <td>14.350000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>johnson2014data</th>\n",
       "      <td>4000</td>\n",
       "      <td>4000.0</td>\n",
       "      <td>-</td>\n",
       "      <td>14.350000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>joshi2012prognostic</th>\n",
       "      <td>10066</td>\n",
       "      <td>10696.0</td>\n",
       "      <td>12.0</td>\n",
       "      <td>4.141735</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>lee2015customization_a</th>\n",
       "      <td>17490</td>\n",
       "      <td>20961.0</td>\n",
       "      <td>17.73</td>\n",
       "      <td>12.690234</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>lehman2012risk</th>\n",
       "      <td>14739</td>\n",
       "      <td>21738.0</td>\n",
       "      <td>14.6</td>\n",
       "      <td>12.319441</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>pirracchio2015mortality</th>\n",
       "      <td>24508</td>\n",
       "      <td>28795.0</td>\n",
       "      <td>12.2</td>\n",
       "      <td>12.720958</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ripoll2014sepsis</th>\n",
       "      <td>2002</td>\n",
       "      <td>2251.0</td>\n",
       "      <td>21.10</td>\n",
       "      <td>39.626833</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>che2016recurrent_b</th>\n",
       "      <td>19714</td>\n",
       "      <td>4000.0</td>\n",
       "      <td>8.7</td>\n",
       "      <td>14.350000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>hug2009icu</th>\n",
       "      <td>10066</td>\n",
       "      <td>10696.0</td>\n",
       "      <td>17.0</td>\n",
       "      <td>6.348168</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>luo2016predicting</th>\n",
       "      <td>7863</td>\n",
       "      <td>8931.0</td>\n",
       "      <td>17.0</td>\n",
       "      <td>6.449446</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>joshi2016identifiable</th>\n",
       "      <td>17000</td>\n",
       "      <td>26508.0</td>\n",
       "      <td>-</td>\n",
       "      <td>14.950204</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ghassemi2014unfolding_c</th>\n",
       "      <td>19308</td>\n",
       "      <td>28172.0</td>\n",
       "      <td>3.23</td>\n",
       "      <td>16.917507</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>grnarova2016neural_b</th>\n",
       "      <td>31244</td>\n",
       "      <td>29572.0</td>\n",
       "      <td>3.70</td>\n",
       "      <td>16.363452</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>lee2015personalized</th>\n",
       "      <td>17490</td>\n",
       "      <td>23443.0</td>\n",
       "      <td>15.1</td>\n",
       "      <td>17.941390</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>lee2015customization_b</th>\n",
       "      <td>17490</td>\n",
       "      <td>20961.0</td>\n",
       "      <td>23.56</td>\n",
       "      <td>17.861743</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>lee2017patient</th>\n",
       "      <td>17152</td>\n",
       "      <td>23443.0</td>\n",
       "      <td>15.1</td>\n",
       "      <td>17.941390</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>luo2016interpretable_a</th>\n",
       "      <td>18412</td>\n",
       "      <td>27747.0</td>\n",
       "      <td>3.4</td>\n",
       "      <td>17.054096</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>wojtusiak2017c</th>\n",
       "      <td>21651</td>\n",
       "      <td>22699.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>7.736024</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>luo2016interpretable_b</th>\n",
       "      <td>18412</td>\n",
       "      <td>27747.0</td>\n",
       "      <td>9.5</td>\n",
       "      <td>25.166685</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ghassemi2014unfolding_d</th>\n",
       "      <td>19308</td>\n",
       "      <td>28172.0</td>\n",
       "      <td>3.34</td>\n",
       "      <td>29.752946</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ghassemi2015multivariate_b</th>\n",
       "      <td>10202</td>\n",
       "      <td>21969.0</td>\n",
       "      <td>-</td>\n",
       "      <td>32.354682</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>grnarova2016neural_c</th>\n",
       "      <td>31244</td>\n",
       "      <td>29572.0</td>\n",
       "      <td>12.06</td>\n",
       "      <td>24.628027</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>lee2015customization_c</th>\n",
       "      <td>17152</td>\n",
       "      <td>20961.0</td>\n",
       "      <td>43.82</td>\n",
       "      <td>31.572921</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                            N_Study  N_Repro Y_Study    Y_Repro\n",
       "Cohort                                                         \n",
       "caballero2015dynamically_a    11648  11648.0       -  13.006525\n",
       "caballero2015dynamically_b    11648  11648.0       -  13.006525\n",
       "caballero2015dynamically_c    11648  11648.0       -  13.006525\n",
       "calvert2016computational       3054   1985.0   12.84  13.803526\n",
       "calvert2016using               9683  18396.0   10.68  14.709720\n",
       "celi2012database_a             1400   4741.0    30.7  23.919004\n",
       "celi2012database_b              223   1070.0    25.6  19.158879\n",
       "che2016recurrent_a             4000  51986.0   13.85   3.095064\n",
       "ding2016mortality              4000   4000.0   13.85  14.350000\n",
       "ghassemi2014unfolding_a       19308  23442.0   10.84  12.916987\n",
       "ghassemi2014unfolding_b       19308  28172.0   10.80  12.200057\n",
       "ghassemi2015multivariate_a    10202  21969.0       -  13.514498\n",
       "grnarova2016neural_a          31244  29572.0   13.82  12.494928\n",
       "harutyunyan2017multitask      42276  45493.0       -  10.535687\n",
       "hoogendoorn2016prediction     13923  17545.0       -  14.967227\n",
       "johnson2012patient             4000   4000.0       -  14.350000\n",
       "johnson2014data                4000   4000.0       -  14.350000\n",
       "joshi2012prognostic           10066  10696.0    12.0   4.141735\n",
       "lee2015customization_a        17490  20961.0   17.73  12.690234\n",
       "lehman2012risk                14739  21738.0    14.6  12.319441\n",
       "pirracchio2015mortality       24508  28795.0    12.2  12.720958\n",
       "ripoll2014sepsis               2002   2251.0   21.10  39.626833\n",
       "che2016recurrent_b            19714   4000.0     8.7  14.350000\n",
       "hug2009icu                    10066  10696.0    17.0   6.348168\n",
       "luo2016predicting              7863   8931.0    17.0   6.449446\n",
       "joshi2016identifiable         17000  26508.0       -  14.950204\n",
       "ghassemi2014unfolding_c       19308  28172.0    3.23  16.917507\n",
       "grnarova2016neural_b          31244  29572.0    3.70  16.363452\n",
       "lee2015personalized           17490  23443.0    15.1  17.941390\n",
       "lee2015customization_b        17490  20961.0   23.56  17.861743\n",
       "lee2017patient                17152  23443.0    15.1  17.941390\n",
       "luo2016interpretable_a        18412  27747.0     3.4  17.054096\n",
       "wojtusiak2017c                21651  22699.0     NaN   7.736024\n",
       "luo2016interpretable_b        18412  27747.0     9.5  25.166685\n",
       "ghassemi2014unfolding_d       19308  28172.0    3.34  29.752946\n",
       "ghassemi2015multivariate_b    10202  21969.0       -  32.354682\n",
       "grnarova2016neural_c          31244  29572.0   12.06  24.628027\n",
       "lee2015customization_c        17152  20961.0  43.82   31.572921"
      ]
     },
     "execution_count": 12,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "study_data = pd.read_csv('../data/study_data.csv')\n",
    "study_data.set_index('Cohort',inplace=True)\n",
    "# add in reproduction sample size // outcome\n",
    "study_data_merged = study_data.merge(repro_stats, how='left',\n",
    "                left_index=True, right_index=True)\n",
    "\n",
    "\n",
    "# print out the table as it was in the paper (maybe a bit more precision)\n",
    "study_data_merged[ ['N_Study','N_Repro','Y_Study','Y_Repro'] ]"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Define K-folds for AUROC comparison"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "metadata": {
    "collapsed": true
   },
   "outputs": [],
   "source": [
    "# define var_static which is used later\n",
    "#TODO: should refactor so this isn't needed\n",
    "var_min, var_max, var_first, var_last, var_sum, var_first_early, var_last_early, var_static = mp.vars_of_interest()\n",
    "\n",
    "K=5\n",
    "np.random.seed(871)\n",
    "# get unique subject_id (this is needed later)\n",
    "sid = np.sort(np.unique(df_death['subject_id'].values))\n",
    "\n",
    "# assign k-fold\n",
    "idxK_sid = np.random.permutation(sid.shape[0])\n",
    "idxK_sid = np.mod(idxK_sid,K)\n",
    "\n",
    "# get indices which map subject_ids in sid to the X dataframe\n",
    "idxMap = np.searchsorted(sid, df_death['subject_id'].values)\n",
    "\n",
    "# use these indices to map the k-fold integers\n",
    "idxK = idxK_sid[idxMap]"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Run results for a single study\n",
    "\n",
    "The below code cell:\n",
    "\n",
    "* extracts the cohort for a specific study\n",
    "* extracts the outcome of that study\n",
    "* builds predictive models in 5-fold cross-validation for that outcome\n",
    "\n",
    "The two models at the moment are Gradient Boosting (xgboost) and logistic regression (scikit-learn).\n",
    "This code cell only runs for one study."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "metadata": {
    "collapsed": false
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "==================================================\n",
      "========== BEGINNING celi2012database_b===========\n",
      "==================================================\n",
      "Reducing sample size from 52050 to 1070 (2.06%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:02:00.055696 - Finished fold 1 of 5. AUROC 0.895.\n",
      "2017-08-24 15:02:00.626802 - Finished fold 2 of 5. AUROC 0.955.\n",
      "2017-08-24 15:02:01.201830 - Finished fold 3 of 5. AUROC 0.900.\n",
      "2017-08-24 15:02:02.202544 - Finished fold 4 of 5. AUROC 0.899.\n",
      "2017-08-24 15:02:03.289922 - Finished fold 5 of 5. AUROC 0.859.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:02:03.327384 - Finished fold 1 of 5. AUROC 0.873.\n",
      "2017-08-24 15:02:03.361398 - Finished fold 2 of 5. AUROC 0.899.\n",
      "2017-08-24 15:02:03.396752 - Finished fold 3 of 5. AUROC 0.868.\n",
      "2017-08-24 15:02:03.436943 - Finished fold 4 of 5. AUROC 0.890.\n",
      "2017-08-24 15:02:03.476754 - Finished fold 5 of 5. AUROC 0.859.\n"
     ]
    }
   ],
   "source": [
    "# pick the study to run the example on\n",
    "current_study = 'celi2012database_b'\n",
    "    \n",
    "# Rough timing info:\n",
    "#     rf - 3 seconds per fold\n",
    "#    xgb - 30 seconds per fold\n",
    "# logreg - 4 seconds per fold\n",
    "#  lasso - 8 seconds per fold\n",
    "models = OrderedDict([\n",
    "          ['xgb', xgb.XGBClassifier(max_depth=3, n_estimators=300, learning_rate=0.05)],\n",
    "          #['lasso', LassoCV(cv=5,fit_intercept=True,normalize=True,max_iter=10000)],\n",
    "          #['rf', RandomForestClassifier()],\n",
    "          ['logreg', LogisticRegression(fit_intercept=True)]\n",
    "         ])\n",
    "\n",
    "print('')\n",
    "print('====================={}==========='.format('='*len(current_study)))\n",
    "print('========== BEGINNING {}==========='.format(current_study))\n",
    "print('====================={}==========='.format('='*len(current_study)))\n",
    "\n",
    "params = exclusions[current_study][0]\n",
    "df_data = mp.get_design_matrix(df, params[0], W=params[1], W_extra=params[2])\n",
    "\n",
    "# get a list of icustay_id who stayed at least 12 hours\n",
    "iid_keep = exclusions[current_study][1](co)\n",
    "print('Reducing sample size from {} to {} ({:2.2f}%).'.format(\n",
    "        df_data.shape[0], iid_keep.shape[0], iid_keep.shape[0]*100.0 / df_data.shape[0]))\n",
    "df_data = df_data.loc[iid_keep,:]\n",
    "print('')\n",
    "\n",
    "y_outcome_label = exclusions[current_study][2]\n",
    "\n",
    "# load the data into a numpy array\n",
    "\n",
    "# first, the data from static vars from df_static\n",
    "X = df_data.merge(df_static.set_index('icustay_id')[var_static], how='left', left_index=True, right_index=True)\n",
    "# next, add in the outcome: death in hospital\n",
    "X = X.merge(co.set_index('icustay_id')[[y_outcome_label]], left_index=True, right_index=True)\n",
    "\n",
    "# map above K-fold indices to this dataset\n",
    "X = X.merge(co.set_index('icustay_id')[['subject_id']], left_index=True, right_index=True)\n",
    "# get indices which map subject_ids in sid to the X dataframe\n",
    "idxMap = np.searchsorted(sid, X['subject_id'].values)\n",
    "# use these indices to map the k-fold integers\n",
    "idxK = idxK_sid[idxMap]\n",
    "# drop the subject_id column\n",
    "X.drop('subject_id',axis=1,inplace=True)\n",
    "\n",
    "# convert to numpy data (assumes target, death, is the last column)\n",
    "X = X.values\n",
    "y = X[:,-1]\n",
    "X = X[:,0:-1]\n",
    "X_header = [x for x in df_data.columns.values] + var_static\n",
    "\n",
    "mdl_val = dict()\n",
    "results_val = dict()\n",
    "pred_val = dict()\n",
    "tar_val = dict()\n",
    "\n",
    "for mdl in models:\n",
    "    print('=============== {} ==============='.format(mdl))\n",
    "    mdl_val[mdl] = list()\n",
    "    results_val[mdl] = list() # initialize list for scores\n",
    "    pred_val[mdl] = list()\n",
    "    tar_val[mdl] = list()\n",
    "\n",
    "    if mdl == 'xgb':\n",
    "        # no pre-processing of data necessary for xgb\n",
    "        estimator = Pipeline([(mdl, models[mdl])])\n",
    "\n",
    "    else:\n",
    "        estimator = Pipeline([(\"imputer\", Imputer(missing_values='NaN',\n",
    "                                          strategy=\"mean\",\n",
    "                                          axis=0)),\n",
    "                      (\"scaler\", StandardScaler()),\n",
    "                      (mdl, models[mdl])]) \n",
    "\n",
    "    for k in range(K):\n",
    "        # train the model using all but the kth fold\n",
    "        curr_mdl = estimator.fit(X[idxK != k, :],y[idxK != k])\n",
    "\n",
    "        # get prediction on this dataset\n",
    "        if mdl == 'lasso':\n",
    "            curr_prob = curr_mdl.predict(X[idxK == k, :])\n",
    "        else:\n",
    "            curr_prob = curr_mdl.predict_proba(X[idxK == k, :])\n",
    "            curr_prob = curr_prob[:,1]\n",
    "\n",
    "        pred_val[mdl].append(curr_prob)\n",
    "        tar_val[mdl].append(y[idxK == k])\n",
    "\n",
    "        # calculate score (AUROC)\n",
    "        curr_score = metrics.roc_auc_score(y[idxK == k], curr_prob)\n",
    "\n",
    "        # add score to list of scores\n",
    "        results_val[mdl].append(curr_score)\n",
    "\n",
    "        # save the current model\n",
    "        mdl_val[mdl].append(curr_mdl)\n",
    "\n",
    "        print('{} - Finished fold {} of {}. AUROC {:0.3f}.'.format(dt.datetime.now(), k+1, K, curr_score))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Run results for all results\n",
    "\n",
    "The below code block is identical to the above code block, except it loops over all studies evaluated. This code block takes a while - it is training ~150 models of each type. The final AUROCs are output to the `results.txt` file. The final models/results/predictions/targets are saved in various dictionaries with the suffix `_all`."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "metadata": {
    "collapsed": false,
    "scrolled": true
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "==================== ========================== ==========\n",
      "========== BEGINNING caballero2015dynamically_a ==========\n",
      "==================== ========================== ==========\n",
      "Reducing sample size from 52050 to 11648 (22.38%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:02:10.689410 - Finished fold 1 of 5. AUROC 0.898.\n",
      "2017-08-24 15:02:19.282924 - Finished fold 2 of 5. AUROC 0.898.\n",
      "2017-08-24 15:02:26.227492 - Finished fold 3 of 5. AUROC 0.914.\n",
      "2017-08-24 15:02:34.092461 - Finished fold 4 of 5. AUROC 0.910.\n",
      "2017-08-24 15:02:38.108726 - Finished fold 5 of 5. AUROC 0.915.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:02:38.598989 - Finished fold 1 of 5. AUROC 0.883.\n",
      "2017-08-24 15:02:39.093343 - Finished fold 2 of 5. AUROC 0.888.\n",
      "2017-08-24 15:02:39.630761 - Finished fold 3 of 5. AUROC 0.882.\n",
      "2017-08-24 15:02:40.178536 - Finished fold 4 of 5. AUROC 0.892.\n",
      "2017-08-24 15:02:40.717573 - Finished fold 5 of 5. AUROC 0.899.\n",
      "\n",
      "==================== ========================== ==========\n",
      "========== BEGINNING caballero2015dynamically_b ==========\n",
      "==================== ========================== ==========\n",
      "Reducing sample size from 52050 to 11648 (22.38%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:02:48.164232 - Finished fold 1 of 5. AUROC 0.915.\n",
      "2017-08-24 15:02:51.448008 - Finished fold 2 of 5. AUROC 0.915.\n",
      "2017-08-24 15:02:56.148969 - Finished fold 3 of 5. AUROC 0.929.\n",
      "2017-08-24 15:03:03.151555 - Finished fold 4 of 5. AUROC 0.924.\n",
      "2017-08-24 15:03:07.006469 - Finished fold 5 of 5. AUROC 0.927.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:03:07.479561 - Finished fold 1 of 5. AUROC 0.893.\n",
      "2017-08-24 15:03:08.019806 - Finished fold 2 of 5. AUROC 0.907.\n",
      "2017-08-24 15:03:08.576943 - Finished fold 3 of 5. AUROC 0.901.\n",
      "2017-08-24 15:03:09.143274 - Finished fold 4 of 5. AUROC 0.912.\n",
      "2017-08-24 15:03:09.691301 - Finished fold 5 of 5. AUROC 0.910.\n",
      "\n",
      "==================== ========================== ==========\n",
      "========== BEGINNING caballero2015dynamically_c ==========\n",
      "==================== ========================== ==========\n",
      "Reducing sample size from 52050 to 11648 (22.38%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:03:19.741895 - Finished fold 1 of 5. AUROC 0.921.\n",
      "2017-08-24 15:03:23.881739 - Finished fold 2 of 5. AUROC 0.926.\n",
      "2017-08-24 15:03:27.843818 - Finished fold 3 of 5. AUROC 0.938.\n",
      "2017-08-24 15:03:31.775496 - Finished fold 4 of 5. AUROC 0.936.\n",
      "2017-08-24 15:03:35.944336 - Finished fold 5 of 5. AUROC 0.936.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:03:36.449209 - Finished fold 1 of 5. AUROC 0.901.\n",
      "2017-08-24 15:03:36.935989 - Finished fold 2 of 5. AUROC 0.919.\n",
      "2017-08-24 15:03:37.424044 - Finished fold 3 of 5. AUROC 0.912.\n",
      "2017-08-24 15:03:37.933657 - Finished fold 4 of 5. AUROC 0.924.\n",
      "2017-08-24 15:03:38.439463 - Finished fold 5 of 5. AUROC 0.922.\n",
      "\n",
      "==================== ======================== ==========\n",
      "========== BEGINNING calvert2016computational ==========\n",
      "==================== ======================== ==========\n",
      "Reducing sample size from 52042 to 1985 (3.81%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:03:41.054190 - Finished fold 1 of 5. AUROC 0.951.\n",
      "2017-08-24 15:03:41.688004 - Finished fold 2 of 5. AUROC 0.970.\n",
      "2017-08-24 15:03:42.411946 - Finished fold 3 of 5. AUROC 0.945.\n",
      "2017-08-24 15:03:43.329728 - Finished fold 4 of 5. AUROC 0.933.\n",
      "2017-08-24 15:03:44.031611 - Finished fold 5 of 5. AUROC 0.974.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:03:44.097718 - Finished fold 1 of 5. AUROC 0.901.\n",
      "2017-08-24 15:03:44.166280 - Finished fold 2 of 5. AUROC 0.948.\n",
      "2017-08-24 15:03:44.241489 - Finished fold 3 of 5. AUROC 0.940.\n",
      "2017-08-24 15:03:44.310584 - Finished fold 4 of 5. AUROC 0.871.\n",
      "2017-08-24 15:03:44.388297 - Finished fold 5 of 5. AUROC 0.955.\n",
      "\n",
      "==================== ================ ==========\n",
      "========== BEGINNING calvert2016using ==========\n",
      "==================== ================ ==========\n",
      "Reducing sample size from 52042 to 18396 (35.35%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:03:52.248697 - Finished fold 1 of 5. AUROC 0.925.\n",
      "2017-08-24 15:03:57.216430 - Finished fold 2 of 5. AUROC 0.942.\n",
      "2017-08-24 15:04:02.256560 - Finished fold 3 of 5. AUROC 0.935.\n",
      "2017-08-24 15:04:07.093441 - Finished fold 4 of 5. AUROC 0.937.\n",
      "2017-08-24 15:04:13.919652 - Finished fold 5 of 5. AUROC 0.933.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:04:14.903489 - Finished fold 1 of 5. AUROC 0.902.\n",
      "2017-08-24 15:04:15.823500 - Finished fold 2 of 5. AUROC 0.925.\n",
      "2017-08-24 15:04:16.921071 - Finished fold 3 of 5. AUROC 0.916.\n",
      "2017-08-24 15:04:18.099623 - Finished fold 4 of 5. AUROC 0.910.\n",
      "2017-08-24 15:04:19.316609 - Finished fold 5 of 5. AUROC 0.913.\n",
      "\n",
      "==================== ================== ==========\n",
      "========== BEGINNING celi2012database_a ==========\n",
      "==================== ================== ==========\n",
      "Reducing sample size from 52050 to 4741 (9.11%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:04:27.530598 - Finished fold 1 of 5. AUROC 0.872.\n",
      "2017-08-24 15:04:29.712421 - Finished fold 2 of 5. AUROC 0.882.\n",
      "2017-08-24 15:04:33.208817 - Finished fold 3 of 5. AUROC 0.878.\n",
      "2017-08-24 15:04:34.883452 - Finished fold 4 of 5. AUROC 0.892.\n",
      "2017-08-24 15:04:36.554279 - Finished fold 5 of 5. AUROC 0.889.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:04:36.675330 - Finished fold 1 of 5. AUROC 0.849.\n",
      "2017-08-24 15:04:36.840260 - Finished fold 2 of 5. AUROC 0.874.\n",
      "2017-08-24 15:04:37.051678 - Finished fold 3 of 5. AUROC 0.877.\n",
      "2017-08-24 15:04:37.219919 - Finished fold 4 of 5. AUROC 0.883.\n",
      "2017-08-24 15:04:37.373168 - Finished fold 5 of 5. AUROC 0.897.\n",
      "\n",
      "==================== ================== ==========\n",
      "========== BEGINNING celi2012database_b ==========\n",
      "==================== ================== ==========\n",
      "Reducing sample size from 52050 to 1070 (2.06%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:04:40.881597 - Finished fold 1 of 5. AUROC 0.895.\n",
      "2017-08-24 15:04:41.361838 - Finished fold 2 of 5. AUROC 0.955.\n",
      "2017-08-24 15:04:42.211288 - Finished fold 3 of 5. AUROC 0.900.\n",
      "2017-08-24 15:04:42.717543 - Finished fold 4 of 5. AUROC 0.899.\n",
      "2017-08-24 15:04:43.161471 - Finished fold 5 of 5. AUROC 0.859.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:04:43.188251 - Finished fold 1 of 5. AUROC 0.873.\n",
      "2017-08-24 15:04:43.225735 - Finished fold 2 of 5. AUROC 0.899.\n",
      "2017-08-24 15:04:43.260163 - Finished fold 3 of 5. AUROC 0.868.\n",
      "2017-08-24 15:04:43.296856 - Finished fold 4 of 5. AUROC 0.890.\n",
      "2017-08-24 15:04:43.332309 - Finished fold 5 of 5. AUROC 0.859.\n",
      "\n",
      "==================== ================== ==========\n",
      "========== BEGINNING che2016recurrent_a ==========\n",
      "==================== ================== ==========\n",
      "Reducing sample size from 52050 to 51986 (99.88%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:05:03.306727 - Finished fold 1 of 5. AUROC 0.989.\n",
      "2017-08-24 15:05:19.245671 - Finished fold 2 of 5. AUROC 0.989.\n",
      "2017-08-24 15:05:34.869711 - Finished fold 3 of 5. AUROC 0.985.\n",
      "2017-08-24 15:05:50.469131 - Finished fold 4 of 5. AUROC 0.984.\n",
      "2017-08-24 15:06:06.107621 - Finished fold 5 of 5. AUROC 0.986.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:06:08.864201 - Finished fold 1 of 5. AUROC 0.969.\n",
      "2017-08-24 15:06:11.630003 - Finished fold 2 of 5. AUROC 0.967.\n",
      "2017-08-24 15:06:14.378411 - Finished fold 3 of 5. AUROC 0.965.\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/usr/local/lib/python2.7/dist-packages/sklearn/linear_model/base.py:352: RuntimeWarning: overflow encountered in exp\n",
      "  np.exp(prob, prob)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "2017-08-24 15:06:16.815520 - Finished fold 4 of 5. AUROC 0.970.\n",
      "2017-08-24 15:06:19.634833 - Finished fold 5 of 5. AUROC 0.961.\n",
      "\n",
      "==================== ================== ==========\n",
      "========== BEGINNING che2016recurrent_b ==========\n",
      "==================== ================== ==========\n",
      "Reducing sample size from 52050 to 4000 (7.68%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:06:24.773976 - Finished fold 1 of 5. AUROC 0.824.\n",
      "2017-08-24 15:06:25.735558 - Finished fold 2 of 5. AUROC 0.826.\n",
      "2017-08-24 15:06:26.777312 - Finished fold 3 of 5. AUROC 0.866.\n",
      "2017-08-24 15:06:27.817189 - Finished fold 4 of 5. AUROC 0.850.\n",
      "2017-08-24 15:06:28.799237 - Finished fold 5 of 5. AUROC 0.858.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:06:28.913223 - Finished fold 1 of 5. AUROC 0.794.\n",
      "2017-08-24 15:06:29.026636 - Finished fold 2 of 5. AUROC 0.836.\n",
      "2017-08-24 15:06:29.169059 - Finished fold 3 of 5. AUROC 0.849.\n",
      "2017-08-24 15:06:29.295513 - Finished fold 4 of 5. AUROC 0.847.\n",
      "2017-08-24 15:06:29.434908 - Finished fold 5 of 5. AUROC 0.829.\n",
      "\n",
      "==================== ================= ==========\n",
      "========== BEGINNING ding2016mortality ==========\n",
      "==================== ================= ==========\n",
      "Reducing sample size from 52050 to 4000 (7.68%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:06:34.537377 - Finished fold 1 of 5. AUROC 0.824.\n",
      "2017-08-24 15:06:35.700315 - Finished fold 2 of 5. AUROC 0.826.\n",
      "2017-08-24 15:06:36.735772 - Finished fold 3 of 5. AUROC 0.866.\n",
      "2017-08-24 15:06:37.732986 - Finished fold 4 of 5. AUROC 0.850.\n",
      "2017-08-24 15:06:38.790253 - Finished fold 5 of 5. AUROC 0.858.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:06:38.912776 - Finished fold 1 of 5. AUROC 0.794.\n",
      "2017-08-24 15:06:39.037103 - Finished fold 2 of 5. AUROC 0.836.\n",
      "2017-08-24 15:06:39.180190 - Finished fold 3 of 5. AUROC 0.849.\n",
      "2017-08-24 15:06:39.314629 - Finished fold 4 of 5. AUROC 0.847.\n",
      "2017-08-24 15:06:39.453793 - Finished fold 5 of 5. AUROC 0.829.\n",
      "\n",
      "==================== ======================= ==========\n",
      "========== BEGINNING ghassemi2014unfolding_a ==========\n",
      "==================== ======================= ==========\n",
      "Reducing sample size from 52050 to 23442 (45.04%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:06:48.268816 - Finished fold 1 of 5. AUROC 0.876.\n",
      "2017-08-24 15:06:54.244002 - Finished fold 2 of 5. AUROC 0.873.\n",
      "2017-08-24 15:07:00.317909 - Finished fold 3 of 5. AUROC 0.882.\n",
      "2017-08-24 15:07:06.380756 - Finished fold 4 of 5. AUROC 0.888.\n",
      "2017-08-24 15:07:12.493694 - Finished fold 5 of 5. AUROC 0.894.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:07:13.443125 - Finished fold 1 of 5. AUROC 0.858.\n",
      "2017-08-24 15:07:14.404426 - Finished fold 2 of 5. AUROC 0.864.\n",
      "2017-08-24 15:07:15.451064 - Finished fold 3 of 5. AUROC 0.862.\n",
      "2017-08-24 15:07:16.719313 - Finished fold 4 of 5. AUROC 0.874.\n",
      "2017-08-24 15:07:17.686592 - Finished fold 5 of 5. AUROC 0.875.\n",
      "\n",
      "==================== ======================= ==========\n",
      "========== BEGINNING ghassemi2014unfolding_b ==========\n",
      "==================== ======================= ==========\n",
      "Reducing sample size from 52050 to 28172 (54.12%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:07:27.449468 - Finished fold 1 of 5. AUROC 0.874.\n",
      "2017-08-24 15:07:34.758833 - Finished fold 2 of 5. AUROC 0.876.\n",
      "2017-08-24 15:07:42.241218 - Finished fold 3 of 5. AUROC 0.882.\n",
      "2017-08-24 15:07:49.577196 - Finished fold 4 of 5. AUROC 0.889.\n",
      "2017-08-24 15:07:56.919700 - Finished fold 5 of 5. AUROC 0.896.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:07:57.978677 - Finished fold 1 of 5. AUROC 0.849.\n",
      "2017-08-24 15:07:59.179914 - Finished fold 2 of 5. AUROC 0.856.\n",
      "2017-08-24 15:08:00.364824 - Finished fold 3 of 5. AUROC 0.856.\n",
      "2017-08-24 15:08:01.756023 - Finished fold 4 of 5. AUROC 0.871.\n",
      "2017-08-24 15:08:02.880160 - Finished fold 5 of 5. AUROC 0.874.\n",
      "\n",
      "==================== ======================= ==========\n",
      "========== BEGINNING ghassemi2014unfolding_c ==========\n",
      "==================== ======================= ==========\n",
      "Reducing sample size from 52050 to 28172 (54.12%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:08:12.680960 - Finished fold 1 of 5. AUROC 0.865.\n",
      "2017-08-24 15:08:20.235484 - Finished fold 2 of 5. AUROC 0.867.\n",
      "2017-08-24 15:08:27.905037 - Finished fold 3 of 5. AUROC 0.868.\n",
      "2017-08-24 15:08:35.257520 - Finished fold 4 of 5. AUROC 0.866.\n",
      "2017-08-24 15:08:42.584230 - Finished fold 5 of 5. AUROC 0.878.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:08:43.571296 - Finished fold 1 of 5. AUROC 0.838.\n",
      "2017-08-24 15:08:44.558976 - Finished fold 2 of 5. AUROC 0.846.\n",
      "2017-08-24 15:08:45.778648 - Finished fold 3 of 5. AUROC 0.845.\n",
      "2017-08-24 15:08:46.996684 - Finished fold 4 of 5. AUROC 0.843.\n",
      "2017-08-24 15:08:47.992288 - Finished fold 5 of 5. AUROC 0.854.\n",
      "\n",
      "==================== ======================= ==========\n",
      "========== BEGINNING ghassemi2014unfolding_d ==========\n",
      "==================== ======================= ==========\n",
      "Reducing sample size from 52050 to 28172 (54.12%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:08:57.612165 - Finished fold 1 of 5. AUROC 0.843.\n",
      "2017-08-24 15:09:05.360247 - Finished fold 2 of 5. AUROC 0.848.\n",
      "2017-08-24 15:09:12.880743 - Finished fold 3 of 5. AUROC 0.841.\n",
      "2017-08-24 15:09:20.232645 - Finished fold 4 of 5. AUROC 0.836.\n",
      "2017-08-24 15:09:27.728024 - Finished fold 5 of 5. AUROC 0.861.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:09:28.844789 - Finished fold 1 of 5. AUROC 0.811.\n",
      "2017-08-24 15:09:30.002385 - Finished fold 2 of 5. AUROC 0.820.\n",
      "2017-08-24 15:09:31.103603 - Finished fold 3 of 5. AUROC 0.817.\n",
      "2017-08-24 15:09:32.577365 - Finished fold 4 of 5. AUROC 0.815.\n",
      "2017-08-24 15:09:33.670365 - Finished fold 5 of 5. AUROC 0.837.\n",
      "\n",
      "==================== ========================== ==========\n",
      "========== BEGINNING ghassemi2015multivariate_a ==========\n",
      "==================== ========================== ==========\n",
      "Reducing sample size from 52050 to 21969 (42.21%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:09:42.227297 - Finished fold 1 of 5. AUROC 0.866.\n",
      "2017-08-24 15:09:51.118765 - Finished fold 2 of 5. AUROC 0.866.\n",
      "2017-08-24 15:09:56.949868 - Finished fold 3 of 5. AUROC 0.876.\n",
      "2017-08-24 15:10:02.832616 - Finished fold 4 of 5. AUROC 0.881.\n",
      "2017-08-24 15:10:08.448307 - Finished fold 5 of 5. AUROC 0.890.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:10:09.318016 - Finished fold 1 of 5. AUROC 0.851.\n",
      "2017-08-24 15:10:10.021191 - Finished fold 2 of 5. AUROC 0.858.\n",
      "2017-08-24 15:10:10.961087 - Finished fold 3 of 5. AUROC 0.856.\n",
      "2017-08-24 15:10:12.093648 - Finished fold 4 of 5. AUROC 0.869.\n",
      "2017-08-24 15:10:13.009346 - Finished fold 5 of 5. AUROC 0.872.\n",
      "\n",
      "==================== ========================== ==========\n",
      "========== BEGINNING ghassemi2015multivariate_b ==========\n",
      "==================== ========================== ==========\n",
      "Reducing sample size from 52050 to 21969 (42.21%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:10:21.376833 - Finished fold 1 of 5. AUROC 0.844.\n",
      "2017-08-24 15:10:26.807198 - Finished fold 2 of 5. AUROC 0.840.\n",
      "2017-08-24 15:10:32.632508 - Finished fold 3 of 5. AUROC 0.837.\n",
      "2017-08-24 15:10:38.312857 - Finished fold 4 of 5. AUROC 0.832.\n",
      "2017-08-24 15:10:43.891150 - Finished fold 5 of 5. AUROC 0.845.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:10:44.722939 - Finished fold 1 of 5. AUROC 0.821.\n",
      "2017-08-24 15:10:45.502482 - Finished fold 2 of 5. AUROC 0.815.\n",
      "2017-08-24 15:10:46.413675 - Finished fold 3 of 5. AUROC 0.817.\n",
      "2017-08-24 15:10:47.468215 - Finished fold 4 of 5. AUROC 0.813.\n",
      "2017-08-24 15:10:48.340077 - Finished fold 5 of 5. AUROC 0.829.\n",
      "\n",
      "==================== ==================== ==========\n",
      "========== BEGINNING grnarova2016neural_a ==========\n",
      "==================== ==================== ==========\n",
      "Reducing sample size from 52050 to 29572 (56.81%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:10:59.567311 - Finished fold 1 of 5. AUROC 0.981.\n",
      "2017-08-24 15:11:08.099722 - Finished fold 2 of 5. AUROC 0.984.\n",
      "2017-08-24 15:11:16.450816 - Finished fold 3 of 5. AUROC 0.983.\n",
      "2017-08-24 15:11:24.756388 - Finished fold 4 of 5. AUROC 0.984.\n",
      "2017-08-24 15:11:34.218908 - Finished fold 5 of 5. AUROC 0.983.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:11:35.371962 - Finished fold 1 of 5. AUROC 0.975.\n",
      "2017-08-24 15:11:36.554050 - Finished fold 2 of 5. AUROC 0.979.\n",
      "2017-08-24 15:11:37.879988 - Finished fold 3 of 5. AUROC 0.981.\n",
      "2017-08-24 15:11:39.030612 - Finished fold 4 of 5. AUROC 0.978.\n",
      "2017-08-24 15:11:40.222049 - Finished fold 5 of 5. AUROC 0.978.\n",
      "\n",
      "==================== ==================== ==========\n",
      "========== BEGINNING grnarova2016neural_b ==========\n",
      "==================== ==================== ==========\n",
      "Reducing sample size from 52050 to 29572 (56.81%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:11:51.525478 - Finished fold 1 of 5. AUROC 0.955.\n",
      "2017-08-24 15:11:59.936454 - Finished fold 2 of 5. AUROC 0.960.\n",
      "2017-08-24 15:12:08.287136 - Finished fold 3 of 5. AUROC 0.964.\n",
      "2017-08-24 15:12:17.039612 - Finished fold 4 of 5. AUROC 0.959.\n",
      "2017-08-24 15:12:25.433224 - Finished fold 5 of 5. AUROC 0.960.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:12:26.884564 - Finished fold 1 of 5. AUROC 0.948.\n",
      "2017-08-24 15:12:28.398257 - Finished fold 2 of 5. AUROC 0.954.\n",
      "2017-08-24 15:12:29.439742 - Finished fold 3 of 5. AUROC 0.957.\n",
      "2017-08-24 15:12:30.365090 - Finished fold 4 of 5. AUROC 0.955.\n",
      "2017-08-24 15:12:31.396458 - Finished fold 5 of 5. AUROC 0.955.\n",
      "\n",
      "==================== ==================== ==========\n",
      "========== BEGINNING grnarova2016neural_c ==========\n",
      "==================== ==================== ==========\n",
      "Reducing sample size from 52050 to 29572 (56.81%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:12:42.771939 - Finished fold 1 of 5. AUROC 0.912.\n",
      "2017-08-24 15:12:51.092638 - Finished fold 2 of 5. AUROC 0.912.\n",
      "2017-08-24 15:12:59.324280 - Finished fold 3 of 5. AUROC 0.915.\n",
      "2017-08-24 15:13:07.637546 - Finished fold 4 of 5. AUROC 0.908.\n",
      "2017-08-24 15:13:16.142746 - Finished fold 5 of 5. AUROC 0.914.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:13:17.238818 - Finished fold 1 of 5. AUROC 0.897.\n",
      "2017-08-24 15:13:18.622335 - Finished fold 2 of 5. AUROC 0.902.\n",
      "2017-08-24 15:13:19.989300 - Finished fold 3 of 5. AUROC 0.909.\n",
      "2017-08-24 15:13:21.072171 - Finished fold 4 of 5. AUROC 0.895.\n",
      "2017-08-24 15:13:22.263586 - Finished fold 5 of 5. AUROC 0.907.\n",
      "\n",
      "==================== ======================== ==========\n",
      "========== BEGINNING harutyunyan2017multitask ==========\n",
      "==================== ======================== ==========\n",
      "Reducing sample size from 52050 to 45493 (87.40%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:13:40.082781 - Finished fold 1 of 5. AUROC 0.936.\n",
      "2017-08-24 15:13:53.608722 - Finished fold 2 of 5. AUROC 0.949.\n",
      "2017-08-24 15:14:07.393697 - Finished fold 3 of 5. AUROC 0.941.\n",
      "2017-08-24 15:14:21.106144 - Finished fold 4 of 5. AUROC 0.941.\n",
      "2017-08-24 15:14:35.089365 - Finished fold 5 of 5. AUROC 0.941.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:14:37.028009 - Finished fold 1 of 5. AUROC 0.921.\n",
      "2017-08-24 15:14:38.945821 - Finished fold 2 of 5. AUROC 0.938.\n",
      "2017-08-24 15:14:40.862447 - Finished fold 3 of 5. AUROC 0.931.\n",
      "2017-08-24 15:14:42.658057 - Finished fold 4 of 5. AUROC 0.927.\n",
      "2017-08-24 15:14:44.579806 - Finished fold 5 of 5. AUROC 0.931.\n",
      "\n",
      "==================== ========================= ==========\n",
      "========== BEGINNING hoogendoorn2016prediction ==========\n",
      "==================== ========================= ==========\n",
      "Reducing sample size from 52050 to 17545 (33.71%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:14:51.871085 - Finished fold 1 of 5. AUROC 0.869.\n",
      "2017-08-24 15:14:56.342646 - Finished fold 2 of 5. AUROC 0.871.\n",
      "2017-08-24 15:15:01.006838 - Finished fold 3 of 5. AUROC 0.878.\n",
      "2017-08-24 15:15:05.619795 - Finished fold 4 of 5. AUROC 0.882.\n",
      "2017-08-24 15:15:10.332091 - Finished fold 5 of 5. AUROC 0.893.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:15:11.325287 - Finished fold 1 of 5. AUROC 0.851.\n",
      "2017-08-24 15:15:12.001155 - Finished fold 2 of 5. AUROC 0.861.\n",
      "2017-08-24 15:15:12.738673 - Finished fold 3 of 5. AUROC 0.860.\n",
      "2017-08-24 15:15:13.610415 - Finished fold 4 of 5. AUROC 0.868.\n",
      "2017-08-24 15:15:14.232124 - Finished fold 5 of 5. AUROC 0.875.\n",
      "\n",
      "==================== ========== ==========\n",
      "========== BEGINNING hug2009icu ==========\n",
      "==================== ========== ==========\n",
      "Reducing sample size from 52050 to 10696 (20.55%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:15:19.990229 - Finished fold 1 of 5. AUROC 0.856.\n",
      "2017-08-24 15:15:23.287701 - Finished fold 2 of 5. AUROC 0.856.\n",
      "2017-08-24 15:15:26.443173 - Finished fold 3 of 5. AUROC 0.864.\n",
      "2017-08-24 15:15:29.857154 - Finished fold 4 of 5. AUROC 0.830.\n",
      "2017-08-24 15:15:33.170536 - Finished fold 5 of 5. AUROC 0.891.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:15:33.732391 - Finished fold 1 of 5. AUROC 0.827.\n",
      "2017-08-24 15:15:34.093158 - Finished fold 2 of 5. AUROC 0.860.\n",
      "2017-08-24 15:15:34.517525 - Finished fold 3 of 5. AUROC 0.863.\n",
      "2017-08-24 15:15:34.961039 - Finished fold 4 of 5. AUROC 0.824.\n",
      "2017-08-24 15:15:35.369909 - Finished fold 5 of 5. AUROC 0.883.\n",
      "\n",
      "==================== ================== ==========\n",
      "========== BEGINNING johnson2012patient ==========\n",
      "==================== ================== ==========\n",
      "Reducing sample size from 52050 to 4000 (7.68%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:15:40.521943 - Finished fold 1 of 5. AUROC 0.824.\n",
      "2017-08-24 15:15:41.561079 - Finished fold 2 of 5. AUROC 0.826.\n",
      "2017-08-24 15:15:42.597157 - Finished fold 3 of 5. AUROC 0.866.\n",
      "2017-08-24 15:15:43.673257 - Finished fold 4 of 5. AUROC 0.850.\n",
      "2017-08-24 15:15:44.875300 - Finished fold 5 of 5. AUROC 0.858.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:15:44.998005 - Finished fold 1 of 5. AUROC 0.794.\n",
      "2017-08-24 15:15:45.134003 - Finished fold 2 of 5. AUROC 0.836.\n",
      "2017-08-24 15:15:45.269519 - Finished fold 3 of 5. AUROC 0.849.\n",
      "2017-08-24 15:15:45.406821 - Finished fold 4 of 5. AUROC 0.847.\n",
      "2017-08-24 15:15:45.545524 - Finished fold 5 of 5. AUROC 0.829.\n",
      "\n",
      "==================== =============== ==========\n",
      "========== BEGINNING johnson2014data ==========\n",
      "==================== =============== ==========\n",
      "Reducing sample size from 52050 to 4000 (7.68%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:15:50.840541 - Finished fold 1 of 5. AUROC 0.824.\n",
      "2017-08-24 15:15:51.866823 - Finished fold 2 of 5. AUROC 0.826.\n",
      "2017-08-24 15:15:52.940034 - Finished fold 3 of 5. AUROC 0.866.\n",
      "2017-08-24 15:15:53.974860 - Finished fold 4 of 5. AUROC 0.850.\n",
      "2017-08-24 15:15:55.036362 - Finished fold 5 of 5. AUROC 0.858.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:15:55.151284 - Finished fold 1 of 5. AUROC 0.794.\n",
      "2017-08-24 15:15:55.288040 - Finished fold 2 of 5. AUROC 0.836.\n",
      "2017-08-24 15:15:55.429835 - Finished fold 3 of 5. AUROC 0.849.\n",
      "2017-08-24 15:15:55.573734 - Finished fold 4 of 5. AUROC 0.847.\n",
      "2017-08-24 15:15:55.703467 - Finished fold 5 of 5. AUROC 0.829.\n",
      "\n",
      "==================== =================== ==========\n",
      "========== BEGINNING joshi2012prognostic ==========\n",
      "==================== =================== ==========\n",
      "Reducing sample size from 52050 to 10696 (20.55%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:16:01.386667 - Finished fold 1 of 5. AUROC 0.888.\n",
      "2017-08-24 15:16:04.590740 - Finished fold 2 of 5. AUROC 0.875.\n",
      "2017-08-24 15:16:09.039714 - Finished fold 3 of 5. AUROC 0.892.\n",
      "2017-08-24 15:16:13.350529 - Finished fold 4 of 5. AUROC 0.872.\n",
      "2017-08-24 15:16:16.621142 - Finished fold 5 of 5. AUROC 0.917.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:16:17.092020 - Finished fold 1 of 5. AUROC 0.853.\n",
      "2017-08-24 15:16:17.576190 - Finished fold 2 of 5. AUROC 0.874.\n",
      "2017-08-24 15:16:18.058006 - Finished fold 3 of 5. AUROC 0.875.\n",
      "2017-08-24 15:16:18.547398 - Finished fold 4 of 5. AUROC 0.873.\n",
      "2017-08-24 15:16:19.036603 - Finished fold 5 of 5. AUROC 0.910.\n",
      "\n",
      "==================== ===================== ==========\n",
      "========== BEGINNING joshi2016identifiable ==========\n",
      "==================== ===================== ==========\n",
      "Reducing sample size from 52050 to 26508 (50.93%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:16:30.462300 - Finished fold 1 of 5. AUROC 0.870.\n",
      "2017-08-24 15:16:37.912466 - Finished fold 2 of 5. AUROC 0.882.\n",
      "2017-08-24 15:16:46.068384 - Finished fold 3 of 5. AUROC 0.873.\n",
      "2017-08-24 15:16:54.116165 - Finished fold 4 of 5. AUROC 0.872.\n",
      "2017-08-24 15:17:02.124129 - Finished fold 5 of 5. AUROC 0.883.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:17:03.573206 - Finished fold 1 of 5. AUROC 0.842.\n",
      "2017-08-24 15:17:05.006596 - Finished fold 2 of 5. AUROC 0.861.\n",
      "2017-08-24 15:17:06.489310 - Finished fold 3 of 5. AUROC 0.850.\n",
      "2017-08-24 15:17:07.588555 - Finished fold 4 of 5. AUROC 0.850.\n",
      "2017-08-24 15:17:08.926979 - Finished fold 5 of 5. AUROC 0.866.\n",
      "\n",
      "==================== ====================== ==========\n",
      "========== BEGINNING lee2015customization_a ==========\n",
      "==================== ====================== ==========\n",
      "Reducing sample size from 52050 to 20961 (40.27%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:17:18.852862 - Finished fold 1 of 5. AUROC 0.873.\n",
      "2017-08-24 15:17:25.588996 - Finished fold 2 of 5. AUROC 0.873.\n",
      "2017-08-24 15:17:31.170566 - Finished fold 3 of 5. AUROC 0.884.\n",
      "2017-08-24 15:17:36.837172 - Finished fold 4 of 5. AUROC 0.888.\n",
      "2017-08-24 15:17:42.578580 - Finished fold 5 of 5. AUROC 0.890.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:17:43.396965 - Finished fold 1 of 5. AUROC 0.858.\n",
      "2017-08-24 15:17:44.244216 - Finished fold 2 of 5. AUROC 0.866.\n",
      "2017-08-24 15:17:45.121461 - Finished fold 3 of 5. AUROC 0.862.\n",
      "2017-08-24 15:17:46.329793 - Finished fold 4 of 5. AUROC 0.871.\n",
      "2017-08-24 15:17:47.156860 - Finished fold 5 of 5. AUROC 0.872.\n",
      "\n",
      "==================== ====================== ==========\n",
      "========== BEGINNING lee2015customization_b ==========\n",
      "==================== ====================== ==========\n",
      "Reducing sample size from 52050 to 20961 (40.27%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:17:55.645648 - Finished fold 1 of 5. AUROC 0.861.\n",
      "2017-08-24 15:18:04.071259 - Finished fold 2 of 5. AUROC 0.861.\n",
      "2017-08-24 15:18:10.178543 - Finished fold 3 of 5. AUROC 0.873.\n",
      "2017-08-24 15:18:16.596000 - Finished fold 4 of 5. AUROC 0.867.\n",
      "2017-08-24 15:18:22.093962 - Finished fold 5 of 5. AUROC 0.868.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:18:22.771169 - Finished fold 1 of 5. AUROC 0.843.\n",
      "2017-08-24 15:18:23.464854 - Finished fold 2 of 5. AUROC 0.847.\n",
      "2017-08-24 15:18:24.164458 - Finished fold 3 of 5. AUROC 0.854.\n",
      "2017-08-24 15:18:25.195832 - Finished fold 4 of 5. AUROC 0.850.\n",
      "2017-08-24 15:18:25.938248 - Finished fold 5 of 5. AUROC 0.853.\n",
      "\n",
      "==================== ====================== ==========\n",
      "========== BEGINNING lee2015customization_c ==========\n",
      "==================== ====================== ==========\n",
      "Reducing sample size from 52050 to 20961 (40.27%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:18:34.194645 - Finished fold 1 of 5. AUROC 0.846.\n",
      "2017-08-24 15:18:40.684562 - Finished fold 2 of 5. AUROC 0.842.\n",
      "2017-08-24 15:18:47.267620 - Finished fold 3 of 5. AUROC 0.846.\n",
      "2017-08-24 15:18:53.750659 - Finished fold 4 of 5. AUROC 0.832.\n",
      "2017-08-24 15:19:00.055388 - Finished fold 5 of 5. AUROC 0.849.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:19:00.826613 - Finished fold 1 of 5. AUROC 0.824.\n",
      "2017-08-24 15:19:01.582516 - Finished fold 2 of 5. AUROC 0.821.\n",
      "2017-08-24 15:19:02.263604 - Finished fold 3 of 5. AUROC 0.824.\n",
      "2017-08-24 15:19:03.304041 - Finished fold 4 of 5. AUROC 0.816.\n",
      "2017-08-24 15:19:04.122467 - Finished fold 5 of 5. AUROC 0.831.\n",
      "\n",
      "==================== =================== ==========\n",
      "========== BEGINNING lee2015personalized ==========\n",
      "==================== =================== ==========\n",
      "Reducing sample size from 52050 to 23443 (45.04%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:19:13.259472 - Finished fold 1 of 5. AUROC 0.864.\n",
      "2017-08-24 15:19:20.613712 - Finished fold 2 of 5. AUROC 0.861.\n",
      "2017-08-24 15:19:26.586256 - Finished fold 3 of 5. AUROC 0.870.\n",
      "2017-08-24 15:19:32.519734 - Finished fold 4 of 5. AUROC 0.869.\n",
      "2017-08-24 15:19:38.647749 - Finished fold 5 of 5. AUROC 0.871.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:19:39.430639 - Finished fold 1 of 5. AUROC 0.843.\n",
      "2017-08-24 15:19:40.226301 - Finished fold 2 of 5. AUROC 0.847.\n",
      "2017-08-24 15:19:40.985881 - Finished fold 3 of 5. AUROC 0.850.\n",
      "2017-08-24 15:19:41.997584 - Finished fold 4 of 5. AUROC 0.855.\n",
      "2017-08-24 15:19:42.732692 - Finished fold 5 of 5. AUROC 0.856.\n",
      "\n",
      "==================== ============== ==========\n",
      "========== BEGINNING lee2017patient ==========\n",
      "==================== ============== ==========\n",
      "Reducing sample size from 52050 to 23443 (45.04%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:19:51.451341 - Finished fold 1 of 5. AUROC 0.864.\n",
      "2017-08-24 15:19:57.571580 - Finished fold 2 of 5. AUROC 0.861.\n",
      "2017-08-24 15:20:03.544430 - Finished fold 3 of 5. AUROC 0.870.\n",
      "2017-08-24 15:20:09.740345 - Finished fold 4 of 5. AUROC 0.869.\n",
      "2017-08-24 15:20:15.619700 - Finished fold 5 of 5. AUROC 0.871.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:20:16.394362 - Finished fold 1 of 5. AUROC 0.843.\n",
      "2017-08-24 15:20:17.177575 - Finished fold 2 of 5. AUROC 0.847.\n",
      "2017-08-24 15:20:17.936568 - Finished fold 3 of 5. AUROC 0.850.\n",
      "2017-08-24 15:20:18.946204 - Finished fold 4 of 5. AUROC 0.855.\n",
      "2017-08-24 15:20:19.683381 - Finished fold 5 of 5. AUROC 0.856.\n",
      "\n",
      "==================== ============== ==========\n",
      "========== BEGINNING lehman2012risk ==========\n",
      "==================== ============== ==========\n",
      "Reducing sample size from 52050 to 21738 (41.76%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:20:28.086366 - Finished fold 1 of 5. AUROC 0.874.\n",
      "2017-08-24 15:20:33.674687 - Finished fold 2 of 5. AUROC 0.881.\n",
      "2017-08-24 15:20:40.119140 - Finished fold 3 of 5. AUROC 0.887.\n",
      "2017-08-24 15:20:48.211066 - Finished fold 4 of 5. AUROC 0.890.\n",
      "2017-08-24 15:20:55.147580 - Finished fold 5 of 5. AUROC 0.895.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:20:56.012699 - Finished fold 1 of 5. AUROC 0.858.\n",
      "2017-08-24 15:20:56.826765 - Finished fold 2 of 5. AUROC 0.873.\n",
      "2017-08-24 15:20:57.794845 - Finished fold 3 of 5. AUROC 0.868.\n",
      "2017-08-24 15:20:58.946668 - Finished fold 4 of 5. AUROC 0.875.\n",
      "2017-08-24 15:20:59.889791 - Finished fold 5 of 5. AUROC 0.879.\n",
      "\n",
      "==================== ====================== ==========\n",
      "========== BEGINNING luo2016interpretable_a ==========\n",
      "==================== ====================== ==========\n",
      "Reducing sample size from 52050 to 27747 (53.31%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:21:12.869564 - Finished fold 1 of 5. AUROC 0.927.\n",
      "2017-08-24 15:21:21.928668 - Finished fold 2 of 5. AUROC 0.927.\n",
      "2017-08-24 15:21:29.987201 - Finished fold 3 of 5. AUROC 0.931.\n",
      "2017-08-24 15:21:39.482411 - Finished fold 4 of 5. AUROC 0.934.\n",
      "2017-08-24 15:21:48.490834 - Finished fold 5 of 5. AUROC 0.927.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:21:49.992450 - Finished fold 1 of 5. AUROC 0.919.\n",
      "2017-08-24 15:21:51.189804 - Finished fold 2 of 5. AUROC 0.916.\n",
      "2017-08-24 15:21:52.660285 - Finished fold 3 of 5. AUROC 0.920.\n",
      "2017-08-24 15:21:53.835775 - Finished fold 4 of 5. AUROC 0.921.\n",
      "2017-08-24 15:21:55.342212 - Finished fold 5 of 5. AUROC 0.920.\n",
      "\n",
      "==================== ====================== ==========\n",
      "========== BEGINNING luo2016interpretable_b ==========\n",
      "==================== ====================== ==========\n",
      "Reducing sample size from 52050 to 27747 (53.31%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:22:06.832750 - Finished fold 1 of 5. AUROC 0.892.\n",
      "2017-08-24 15:22:14.554670 - Finished fold 2 of 5. AUROC 0.897.\n",
      "2017-08-24 15:22:22.501011 - Finished fold 3 of 5. AUROC 0.887.\n",
      "2017-08-24 15:22:30.386923 - Finished fold 4 of 5. AUROC 0.892.\n",
      "2017-08-24 15:22:38.386335 - Finished fold 5 of 5. AUROC 0.889.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:22:39.712522 - Finished fold 1 of 5. AUROC 0.877.\n",
      "2017-08-24 15:22:41.335352 - Finished fold 2 of 5. AUROC 0.877.\n",
      "2017-08-24 15:22:42.827553 - Finished fold 3 of 5. AUROC 0.874.\n",
      "2017-08-24 15:22:44.282435 - Finished fold 4 of 5. AUROC 0.879.\n",
      "2017-08-24 15:22:45.808676 - Finished fold 5 of 5. AUROC 0.875.\n",
      "\n",
      "==================== ================= ==========\n",
      "========== BEGINNING luo2016predicting ==========\n",
      "==================== ================= ==========\n",
      "Reducing sample size from 52050 to 8931 (17.16%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:22:51.070702 - Finished fold 1 of 5. AUROC 0.821.\n",
      "2017-08-24 15:22:53.597344 - Finished fold 2 of 5. AUROC 0.835.\n",
      "2017-08-24 15:22:56.092545 - Finished fold 3 of 5. AUROC 0.835.\n",
      "2017-08-24 15:22:58.591427 - Finished fold 4 of 5. AUROC 0.804.\n",
      "2017-08-24 15:23:01.326893 - Finished fold 5 of 5. AUROC 0.857.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:23:01.680617 - Finished fold 1 of 5. AUROC 0.806.\n",
      "2017-08-24 15:23:02.050825 - Finished fold 2 of 5. AUROC 0.856.\n",
      "2017-08-24 15:23:02.425472 - Finished fold 3 of 5. AUROC 0.833.\n",
      "2017-08-24 15:23:02.815213 - Finished fold 4 of 5. AUROC 0.792.\n",
      "2017-08-24 15:23:03.167318 - Finished fold 5 of 5. AUROC 0.847.\n",
      "\n",
      "==================== ======================= ==========\n",
      "========== BEGINNING pirracchio2015mortality ==========\n",
      "==================== ======================= ==========\n",
      "Reducing sample size from 52050 to 28795 (55.32%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:23:15.657638 - Finished fold 1 of 5. AUROC 0.902.\n",
      "2017-08-24 15:23:24.894364 - Finished fold 2 of 5. AUROC 0.900.\n",
      "2017-08-24 15:23:36.638564 - Finished fold 3 of 5. AUROC 0.910.\n",
      "2017-08-24 15:23:46.210677 - Finished fold 4 of 5. AUROC 0.908.\n",
      "2017-08-24 15:23:55.829423 - Finished fold 5 of 5. AUROC 0.916.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:23:56.907370 - Finished fold 1 of 5. AUROC 0.882.\n",
      "2017-08-24 15:23:58.054082 - Finished fold 2 of 5. AUROC 0.890.\n",
      "2017-08-24 15:23:59.186352 - Finished fold 3 of 5. AUROC 0.892.\n",
      "2017-08-24 15:24:00.652185 - Finished fold 4 of 5. AUROC 0.895.\n",
      "2017-08-24 15:24:01.786215 - Finished fold 5 of 5. AUROC 0.898.\n",
      "\n",
      "==================== ================ ==========\n",
      "========== BEGINNING ripoll2014sepsis ==========\n",
      "==================== ================ ==========\n",
      "Reducing sample size from 52050 to 2251 (4.32%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:24:05.535427 - Finished fold 1 of 5. AUROC 0.799.\n",
      "2017-08-24 15:24:06.345012 - Finished fold 2 of 5. AUROC 0.791.\n",
      "2017-08-24 15:24:07.197001 - Finished fold 3 of 5. AUROC 0.796.\n",
      "2017-08-24 15:24:08.108112 - Finished fold 4 of 5. AUROC 0.832.\n",
      "2017-08-24 15:24:08.981216 - Finished fold 5 of 5. AUROC 0.789.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:24:09.031167 - Finished fold 1 of 5. AUROC 0.772.\n",
      "2017-08-24 15:24:09.115938 - Finished fold 2 of 5. AUROC 0.787.\n",
      "2017-08-24 15:24:09.194739 - Finished fold 3 of 5. AUROC 0.768.\n",
      "2017-08-24 15:24:09.271099 - Finished fold 4 of 5. AUROC 0.817.\n",
      "2017-08-24 15:24:09.355291 - Finished fold 5 of 5. AUROC 0.792.\n",
      "\n",
      "==================== ============== ==========\n",
      "========== BEGINNING wojtusiak2017c ==========\n",
      "==================== ============== ==========\n",
      "Reducing sample size from 52050 to 22699 (43.61%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:24:18.728748 - Finished fold 1 of 5. AUROC 0.799.\n",
      "2017-08-24 15:24:24.912566 - Finished fold 2 of 5. AUROC 0.786.\n",
      "2017-08-24 15:24:31.111226 - Finished fold 3 of 5. AUROC 0.802.\n",
      "2017-08-24 15:24:37.281332 - Finished fold 4 of 5. AUROC 0.816.\n",
      "2017-08-24 15:24:45.421267 - Finished fold 5 of 5. AUROC 0.792.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:24:46.606003 - Finished fold 1 of 5. AUROC 0.780.\n",
      "2017-08-24 15:24:47.530606 - Finished fold 2 of 5. AUROC 0.785.\n",
      "2017-08-24 15:24:48.611508 - Finished fold 3 of 5. AUROC 0.791.\n",
      "2017-08-24 15:24:49.833434 - Finished fold 4 of 5. AUROC 0.802.\n",
      "2017-08-24 15:24:51.279982 - Finished fold 5 of 5. AUROC 0.808.\n"
     ]
    }
   ],
   "source": [
    "mdl_val_all = dict()\n",
    "results_val_all = dict()\n",
    "pred_val_all = dict()\n",
    "tar_val_all = dict()\n",
    "\n",
    "# Rough timing info:\n",
    "#     rf - 3 seconds per fold\n",
    "#    xgb - 30 seconds per fold\n",
    "# logreg - 4 seconds per fold\n",
    "#  lasso - 8 seconds per fold\n",
    "models = OrderedDict([\n",
    "          ['xgb', xgb.XGBClassifier(max_depth=3, n_estimators=300, learning_rate=0.05)],\n",
    "          #['lasso', LassoCV(cv=5,fit_intercept=True,normalize=True,max_iter=10000)],\n",
    "          #['rf', RandomForestClassifier()],\n",
    "          ['logreg', LogisticRegression(fit_intercept=True)]\n",
    "         ])\n",
    "    \n",
    "with open('results.txt','w') as fp:\n",
    "    fp.write('StudyName,SampleSize,Outcome')\n",
    "    for mdl in models:\n",
    "        fp.write(',{}'.format(mdl))\n",
    "    fp.write('\\n')\n",
    "    \n",
    "for current_study in exclusions:    \n",
    "    print('\\n==================== {} =========='.format('='*len(current_study)))\n",
    "    print('========== BEGINNING {} =========='.format(current_study))\n",
    "    print('==================== {} =========='.format('='*len(current_study)))\n",
    "\n",
    "    params = exclusions[current_study][0]\n",
    "    df_data = mp.get_design_matrix(df, params[0], W=params[1], W_extra=params[2])\n",
    "\n",
    "    # get a list of icustay_id who stayed at least 12 hours\n",
    "    iid_keep = exclusions[current_study][1](co)\n",
    "    print('Reducing sample size from {} to {} ({:2.2f}%).'.format(\n",
    "            df_data.shape[0], iid_keep.shape[0], iid_keep.shape[0]*100.0 / df_data.shape[0]))\n",
    "    df_data = df_data.loc[iid_keep,:]\n",
    "    print('')\n",
    "\n",
    "    y_outcome_label = exclusions[current_study][2]\n",
    "    \n",
    "    # load the data into a numpy array\n",
    "\n",
    "    # first, the data from static vars from df_static\n",
    "    X = df_data.merge(df_static.set_index('icustay_id')[var_static], how='left', left_index=True, right_index=True)\n",
    "    # next, add in the outcome: death in hospital\n",
    "    X = X.merge(co.set_index('icustay_id')[[y_outcome_label]], left_index=True, right_index=True)\n",
    "\n",
    "    # map above K-fold indices to this dataset\n",
    "    X = X.merge(co.set_index('icustay_id')[['subject_id']], left_index=True, right_index=True)\n",
    "    # get indices which map subject_ids in sid to the X dataframe\n",
    "    idxMap = np.searchsorted(sid, X['subject_id'].values)\n",
    "    # use these indices to map the k-fold integers\n",
    "    idxK = idxK_sid[idxMap]\n",
    "    # drop the subject_id column\n",
    "    X.drop('subject_id',axis=1,inplace=True)\n",
    "\n",
    "    # convert to numpy data (assumes target, death, is the last column)\n",
    "    X = X.values\n",
    "    y = X[:,-1]\n",
    "    X = X[:,0:-1]\n",
    "    X_header = [x for x in df_data.columns.values] + var_static\n",
    "    \n",
    "    mdl_val = dict()\n",
    "    results_val = dict()\n",
    "    pred_val = dict()\n",
    "    tar_val = dict()\n",
    "\n",
    "    for mdl in models:\n",
    "        print('=============== {} ==============='.format(mdl))\n",
    "        mdl_val[mdl] = list()\n",
    "        results_val[mdl] = list() # initialize list for scores\n",
    "        pred_val[mdl] = list()\n",
    "        tar_val[mdl] = list()\n",
    "\n",
    "        if mdl == 'xgb':\n",
    "            # no pre-processing of data necessary for xgb\n",
    "            estimator = Pipeline([(mdl, models[mdl])])\n",
    "\n",
    "        else:\n",
    "            estimator = Pipeline([(\"imputer\", Imputer(missing_values='NaN',\n",
    "                                              strategy=\"mean\",\n",
    "                                              axis=0)),\n",
    "                          (\"scaler\", StandardScaler()),\n",
    "                          (mdl, models[mdl])]) \n",
    "\n",
    "        for k in range(K):\n",
    "            # train the model using all but the kth fold\n",
    "            curr_mdl = estimator.fit(X[idxK != k, :],y[idxK != k])\n",
    "\n",
    "            # get prediction on this dataset\n",
    "            if mdl == 'lasso':\n",
    "                curr_prob = curr_mdl.predict(X[idxK == k, :])\n",
    "            else:\n",
    "                curr_prob = curr_mdl.predict_proba(X[idxK == k, :])\n",
    "                curr_prob = curr_prob[:,1]\n",
    "\n",
    "            pred_val[mdl].append(curr_prob)\n",
    "            tar_val[mdl].append(y[idxK == k])\n",
    "\n",
    "            # calculate score (AUROC)\n",
    "            curr_score = metrics.roc_auc_score(y[idxK == k], curr_prob)\n",
    "\n",
    "            # add score to list of scores\n",
    "            results_val[mdl].append(curr_score)\n",
    "\n",
    "            # save the current model\n",
    "            mdl_val[mdl].append(curr_mdl)\n",
    "\n",
    "            print('{} - Finished fold {} of {}. AUROC {:0.3f}.'.format(dt.datetime.now(), k+1, K, curr_score))\n",
    "\n",
    "    # create a pointer for above dicts with new var names\n",
    "    # we will likely re-use the dicts in subsequent calls for getting model perfomances\n",
    "    mdl_val_all[current_study] = mdl_val\n",
    "    results_val_all[current_study] = results_val\n",
    "    pred_val_all[current_study] = pred_val\n",
    "    tar_val_all[current_study] = tar_val\n",
    "    \n",
    "    # print to file\n",
    "    with open('results.txt','a') as fp:\n",
    "        # print study name, sample size and frequency of outcome\n",
    "        fp.write( '{},{},{:2.2f}'.format(current_study, X.shape[0], np.mean(y)*100.0 ) )\n",
    "        \n",
    "        for i, mdl in enumerate(models):\n",
    "            fp.write(',{:0.6f}'.format( np.mean(results_val[mdl]) ))\n",
    "        \n",
    "        fp.write('\\n')"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Move the results from the above dictionaries into a single dataframe.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "metadata": {
    "collapsed": false
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Outcome</th>\n",
       "      <th>N_Study</th>\n",
       "      <th>N_Repro</th>\n",
       "      <th>Y_Study</th>\n",
       "      <th>Y_Repro</th>\n",
       "      <th>AUROC_Study</th>\n",
       "      <th>xgb</th>\n",
       "      <th>logreg</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Cohort</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>caballero2015dynamically_a</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>11648</td>\n",
       "      <td>11648.0</td>\n",
       "      <td>-</td>\n",
       "      <td>13.006525</td>\n",
       "      <td>0.8657</td>\n",
       "      <td>0.907000</td>\n",
       "      <td>0.888772</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>caballero2015dynamically_b</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>11648</td>\n",
       "      <td>11648.0</td>\n",
       "      <td>-</td>\n",
       "      <td>13.006525</td>\n",
       "      <td>0.7985</td>\n",
       "      <td>0.922231</td>\n",
       "      <td>0.904719</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>caballero2015dynamically_c</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>11648</td>\n",
       "      <td>11648.0</td>\n",
       "      <td>-</td>\n",
       "      <td>13.006525</td>\n",
       "      <td>0.7385</td>\n",
       "      <td>0.931345</td>\n",
       "      <td>0.915472</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>calvert2016computational</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>3054</td>\n",
       "      <td>1985.0</td>\n",
       "      <td>12.84</td>\n",
       "      <td>13.803526</td>\n",
       "      <td>0.9340</td>\n",
       "      <td>0.954481</td>\n",
       "      <td>0.923016</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>calvert2016using</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>9683</td>\n",
       "      <td>18396.0</td>\n",
       "      <td>10.68</td>\n",
       "      <td>14.709720</td>\n",
       "      <td>0.8800</td>\n",
       "      <td>0.934364</td>\n",
       "      <td>0.913103</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>celi2012database_a</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>1400</td>\n",
       "      <td>4741.0</td>\n",
       "      <td>30.7</td>\n",
       "      <td>23.919004</td>\n",
       "      <td>0.8750</td>\n",
       "      <td>0.882389</td>\n",
       "      <td>0.875887</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>celi2012database_b</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>223</td>\n",
       "      <td>1070.0</td>\n",
       "      <td>25.6</td>\n",
       "      <td>19.158879</td>\n",
       "      <td>0.9580</td>\n",
       "      <td>0.901737</td>\n",
       "      <td>0.877720</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>che2016recurrent_a</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>4000</td>\n",
       "      <td>51986.0</td>\n",
       "      <td>13.85</td>\n",
       "      <td>3.095064</td>\n",
       "      <td>0.8424</td>\n",
       "      <td>0.986628</td>\n",
       "      <td>0.966270</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ding2016mortality</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>4000</td>\n",
       "      <td>4000.0</td>\n",
       "      <td>13.85</td>\n",
       "      <td>14.350000</td>\n",
       "      <td>0.8177</td>\n",
       "      <td>0.844859</td>\n",
       "      <td>0.831190</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ghassemi2014unfolding_a</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>19308</td>\n",
       "      <td>23442.0</td>\n",
       "      <td>10.84</td>\n",
       "      <td>12.916987</td>\n",
       "      <td>0.8400</td>\n",
       "      <td>0.882558</td>\n",
       "      <td>0.866768</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ghassemi2014unfolding_b</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>19308</td>\n",
       "      <td>28172.0</td>\n",
       "      <td>10.80</td>\n",
       "      <td>12.200057</td>\n",
       "      <td>0.8410</td>\n",
       "      <td>0.883465</td>\n",
       "      <td>0.861244</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ghassemi2015multivariate_a</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>10202</td>\n",
       "      <td>21969.0</td>\n",
       "      <td>-</td>\n",
       "      <td>13.514498</td>\n",
       "      <td>0.8120</td>\n",
       "      <td>0.875999</td>\n",
       "      <td>0.861076</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>grnarova2016neural_a</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>31244</td>\n",
       "      <td>29572.0</td>\n",
       "      <td>13.82</td>\n",
       "      <td>12.494928</td>\n",
       "      <td>0.9630</td>\n",
       "      <td>0.982942</td>\n",
       "      <td>0.978148</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>harutyunyan2017multitask</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>42276</td>\n",
       "      <td>45493.0</td>\n",
       "      <td>-</td>\n",
       "      <td>10.535687</td>\n",
       "      <td>0.8625</td>\n",
       "      <td>0.941598</td>\n",
       "      <td>0.929507</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>hoogendoorn2016prediction</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>13923</td>\n",
       "      <td>17545.0</td>\n",
       "      <td>-</td>\n",
       "      <td>14.967227</td>\n",
       "      <td>0.8410</td>\n",
       "      <td>0.878471</td>\n",
       "      <td>0.863137</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>johnson2012patient</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>4000</td>\n",
       "      <td>4000.0</td>\n",
       "      <td>-</td>\n",
       "      <td>14.350000</td>\n",
       "      <td>0.8602</td>\n",
       "      <td>0.844859</td>\n",
       "      <td>0.831190</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>johnson2014data</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>4000</td>\n",
       "      <td>4000.0</td>\n",
       "      <td>-</td>\n",
       "      <td>14.350000</td>\n",
       "      <td>0.8457</td>\n",
       "      <td>0.844859</td>\n",
       "      <td>0.831190</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>joshi2012prognostic</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>10066</td>\n",
       "      <td>10696.0</td>\n",
       "      <td>12.0</td>\n",
       "      <td>4.141735</td>\n",
       "      <td>0.8900</td>\n",
       "      <td>0.888800</td>\n",
       "      <td>0.876938</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>lee2015customization_a</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>17490</td>\n",
       "      <td>20961.0</td>\n",
       "      <td>17.73</td>\n",
       "      <td>12.690234</td>\n",
       "      <td>0.7750</td>\n",
       "      <td>0.881796</td>\n",
       "      <td>0.865851</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>lehman2012risk</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>14739</td>\n",
       "      <td>21738.0</td>\n",
       "      <td>14.6</td>\n",
       "      <td>12.319441</td>\n",
       "      <td>0.8200</td>\n",
       "      <td>0.885441</td>\n",
       "      <td>0.870387</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>pirracchio2015mortality</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>24508</td>\n",
       "      <td>28795.0</td>\n",
       "      <td>12.2</td>\n",
       "      <td>12.720958</td>\n",
       "      <td>0.8800</td>\n",
       "      <td>0.907004</td>\n",
       "      <td>0.891246</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ripoll2014sepsis</th>\n",
       "      <td>death_in_hospital</td>\n",
       "      <td>2002</td>\n",
       "      <td>2251.0</td>\n",
       "      <td>21.10</td>\n",
       "      <td>39.626833</td>\n",
       "      <td>0.8223</td>\n",
       "      <td>0.801198</td>\n",
       "      <td>0.787370</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>che2016recurrent_b</th>\n",
       "      <td>death_48hr_post_icu_admit</td>\n",
       "      <td>19714</td>\n",
       "      <td>4000.0</td>\n",
       "      <td>8.7</td>\n",
       "      <td>14.350000</td>\n",
       "      <td>0.8527</td>\n",
       "      <td>0.844859</td>\n",
       "      <td>0.831190</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>hug2009icu</th>\n",
       "      <td>death_30dy_post_icu_disch</td>\n",
       "      <td>10066</td>\n",
       "      <td>10696.0</td>\n",
       "      <td>17.0</td>\n",
       "      <td>6.348168</td>\n",
       "      <td>0.8790</td>\n",
       "      <td>0.859368</td>\n",
       "      <td>0.851372</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>luo2016predicting</th>\n",
       "      <td>death_30dy_post_icu_disch</td>\n",
       "      <td>7863</td>\n",
       "      <td>8931.0</td>\n",
       "      <td>17.0</td>\n",
       "      <td>6.449446</td>\n",
       "      <td>0.8480</td>\n",
       "      <td>0.830696</td>\n",
       "      <td>0.826844</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>joshi2016identifiable</th>\n",
       "      <td>death_30dy_post_icu_disch</td>\n",
       "      <td>17000</td>\n",
       "      <td>26508.0</td>\n",
       "      <td>-</td>\n",
       "      <td>14.950204</td>\n",
       "      <td>0.7200</td>\n",
       "      <td>0.876016</td>\n",
       "      <td>0.853926</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ghassemi2014unfolding_c</th>\n",
       "      <td>death_30dy_post_hos_disch</td>\n",
       "      <td>19308</td>\n",
       "      <td>28172.0</td>\n",
       "      <td>3.23</td>\n",
       "      <td>16.917507</td>\n",
       "      <td>0.7610</td>\n",
       "      <td>0.868777</td>\n",
       "      <td>0.845200</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>grnarova2016neural_b</th>\n",
       "      <td>death_30dy_post_hos_disch</td>\n",
       "      <td>31244</td>\n",
       "      <td>29572.0</td>\n",
       "      <td>3.70</td>\n",
       "      <td>16.363452</td>\n",
       "      <td>0.8580</td>\n",
       "      <td>0.959645</td>\n",
       "      <td>0.953682</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>lee2015personalized</th>\n",
       "      <td>death_30dy_post_hos_disch</td>\n",
       "      <td>17490</td>\n",
       "      <td>23443.0</td>\n",
       "      <td>15.1</td>\n",
       "      <td>17.941390</td>\n",
       "      <td>0.7840</td>\n",
       "      <td>0.867168</td>\n",
       "      <td>0.850062</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>lee2015customization_b</th>\n",
       "      <td>death_30dy_post_hos_disch</td>\n",
       "      <td>17490</td>\n",
       "      <td>20961.0</td>\n",
       "      <td>23.56</td>\n",
       "      <td>17.861743</td>\n",
       "      <td>0.7620</td>\n",
       "      <td>0.865947</td>\n",
       "      <td>0.849294</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>lee2017patient</th>\n",
       "      <td>death_30dy_post_hos_disch</td>\n",
       "      <td>17152</td>\n",
       "      <td>23443.0</td>\n",
       "      <td>15.1</td>\n",
       "      <td>17.941390</td>\n",
       "      <td>0.8150</td>\n",
       "      <td>0.867168</td>\n",
       "      <td>0.850062</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>luo2016interpretable_a</th>\n",
       "      <td>death_30dy_post_hos_disch</td>\n",
       "      <td>18412</td>\n",
       "      <td>27747.0</td>\n",
       "      <td>3.4</td>\n",
       "      <td>17.054096</td>\n",
       "      <td>0.8600</td>\n",
       "      <td>0.929155</td>\n",
       "      <td>0.919350</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>wojtusiak2017c</th>\n",
       "      <td>death_30dy_post_hos_disch</td>\n",
       "      <td>21651</td>\n",
       "      <td>22699.0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>7.736024</td>\n",
       "      <td>0.7340</td>\n",
       "      <td>0.798828</td>\n",
       "      <td>0.793172</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>luo2016interpretable_b</th>\n",
       "      <td>death_6mo_post_hos_disch</td>\n",
       "      <td>18412</td>\n",
       "      <td>27747.0</td>\n",
       "      <td>9.5</td>\n",
       "      <td>25.166685</td>\n",
       "      <td>0.8420</td>\n",
       "      <td>0.891435</td>\n",
       "      <td>0.876588</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ghassemi2014unfolding_d</th>\n",
       "      <td>death_1yr_post_hos_disch</td>\n",
       "      <td>19308</td>\n",
       "      <td>28172.0</td>\n",
       "      <td>3.34</td>\n",
       "      <td>29.752946</td>\n",
       "      <td>0.7430</td>\n",
       "      <td>0.845817</td>\n",
       "      <td>0.819841</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>ghassemi2015multivariate_b</th>\n",
       "      <td>death_1yr_post_hos_disch</td>\n",
       "      <td>10202</td>\n",
       "      <td>21969.0</td>\n",
       "      <td>-</td>\n",
       "      <td>32.354682</td>\n",
       "      <td>0.6860</td>\n",
       "      <td>0.839746</td>\n",
       "      <td>0.818851</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>grnarova2016neural_c</th>\n",
       "      <td>death_1yr_post_hos_disch</td>\n",
       "      <td>31244</td>\n",
       "      <td>29572.0</td>\n",
       "      <td>12.06</td>\n",
       "      <td>24.628027</td>\n",
       "      <td>0.8530</td>\n",
       "      <td>0.912094</td>\n",
       "      <td>0.901945</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>lee2015customization_c</th>\n",
       "      <td>death_2yr_post_hos_disch</td>\n",
       "      <td>17152</td>\n",
       "      <td>20961.0</td>\n",
       "      <td>43.82</td>\n",
       "      <td>31.572921</td>\n",
       "      <td>0.8300</td>\n",
       "      <td>0.842981</td>\n",
       "      <td>0.823152</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>"
      ],
      "text/plain": [
       "<IPython.core.display.HTML object>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "mdl_list = models.keys()\n",
    "\n",
    "study_data = pd.read_csv('../data/study_data.csv')\n",
    "study_data.set_index('Cohort',inplace=True)\n",
    "\n",
    "# add in reproduction stats from earlier\n",
    "study_data_merged = study_data.merge(repro_stats, how='left',\n",
    "                left_index=True, right_index=True)\n",
    "\n",
    "# add in AUROCs\n",
    "for current_study in results_val_all:\n",
    "    results_val = results_val_all[current_study]\n",
    "    for mdl in results_val:\n",
    "        study_data_merged.loc[current_study, mdl] = np.mean(results_val[mdl])\n",
    "    \n",
    "columns = ['Outcome','N_Study','N_Repro','Y_Study','Y_Repro','AUROC_Study'] + mdl_list\n",
    "display(HTML(study_data_merged[columns].to_html()))\n",
    "\n",
    "study_data_merged.to_csv('results_final.csv')"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Appendix\n",
    "\n",
    "## Baseline model 1\n",
    "\n",
    "The below code block builds a \"baseline\" model. This model has no exclusions past the base cohort exclusions. K-fold validation is done on the patient level to ensure no information leakage between training/validation sets. The outcome is in-hospital mortality, and the data window used is the first 24 hours. Labs are extracted from up to 24 hours before the ICU admission (this is defined by `W_extra=24`)."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 26,
   "metadata": {
    "collapsed": true
   },
   "outputs": [],
   "source": [
    "W = 24 # window size\n",
    "W_extra = 24 # extra time backward for labs\n",
    "y_outcome_label = 'death_in_hospital'\n",
    "\n",
    "# admission+W hours\n",
    "df_tmp=co.copy().set_index('icustay_id')\n",
    "time_dict = df_tmp.copy()\n",
    "time_dict['windowtime'] = W\n",
    "time_dict = time_dict['windowtime'].to_dict()\n",
    "\n",
    "\n",
    "# Rough timing info:\n",
    "#     rf - 3 seconds per fold\n",
    "#    xgb - 30 seconds per fold\n",
    "# logreg - 4 seconds per fold\n",
    "#  lasso - 8 seconds per fold\n",
    "models = OrderedDict([\n",
    "          ['xgb', xgb.XGBClassifier(max_depth=3, n_estimators=300, learning_rate=0.05)],\n",
    "          #['lasso', LassoCV(cv=5,fit_intercept=True,normalize=True,max_iter=10000)],\n",
    "          #['rf', RandomForestClassifier()],\n",
    "          ['logreg', LogisticRegression(fit_intercept=True)]\n",
    "         ])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 27,
   "metadata": {
    "collapsed": false
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "========================================\n",
      "========== BEGINNING baseline ==========\n",
      "========================================\n",
      "Reducing sample size from 52085 to 38687 (74.33%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:37:20.547733 - Finished fold 1 of 5. AUROC 0.880.\n",
      "2017-08-24 15:37:31.865971 - Finished fold 2 of 5. AUROC 0.888.\n",
      "2017-08-24 15:37:43.304737 - Finished fold 3 of 5. AUROC 0.887.\n",
      "2017-08-24 15:37:54.738620 - Finished fold 4 of 5. AUROC 0.886.\n",
      "2017-08-24 15:38:06.204805 - Finished fold 5 of 5. AUROC 0.897.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:38:07.586226 - Finished fold 1 of 5. AUROC 0.868.\n",
      "2017-08-24 15:38:09.071851 - Finished fold 2 of 5. AUROC 0.871.\n",
      "2017-08-24 15:38:10.688616 - Finished fold 3 of 5. AUROC 0.863.\n",
      "2017-08-24 15:38:12.239024 - Finished fold 4 of 5. AUROC 0.862.\n",
      "2017-08-24 15:38:13.748468 - Finished fold 5 of 5. AUROC 0.880.\n",
      "\n",
      "StudyName,SampleSize,xgb,logreg\n",
      "baseline,38687,0.887690,0.868978\n",
      "\n"
     ]
    }
   ],
   "source": [
    "CENSOR_FLAG=False\n",
    "current_study = 'baseline'\n",
    "\n",
    "print('')\n",
    "print('====================={}==========='.format('='*len(current_study)))\n",
    "print('========== BEGINNING {} =========='.format(current_study))\n",
    "print('====================={}==========='.format('='*len(current_study)))\n",
    "\n",
    "# optionally remove patients who were DNR in first 24hrs\n",
    "if CENSOR_FLAG:\n",
    "    exclFcn = lambda x: x.loc[x['inclusion_stay_ge_24hr']& ( (x['censortime_hours'].isnull()) | (x['censortime_hours']>=24) ) ,'icustay_id'].values\n",
    "else:\n",
    "    exclFcn = lambda x: x.loc[x['inclusion_stay_ge_24hr']& ( (x['censortime_hours'].isnull()) | (x['censortime_hours']>=24) ) ,'icustay_id'].values\n",
    "    \n",
    "df_data = mp.get_design_matrix(df, time_dict, W=W, W_extra=W_extra)\n",
    "\n",
    "iid_keep = exclFcn(co)\n",
    "\n",
    "N_NEW=df_data.loc[iid_keep,:].shape[0]\n",
    "print('Reducing sample size from {} to {} ({:2.2f}%).'.format(\n",
    "        co.shape[0], N_NEW, N_NEW*100.0 / df_data.shape[0]))\n",
    "df_data = df_data.loc[iid_keep,:]\n",
    "print('')\n",
    "\n",
    "# load the data into a numpy array\n",
    "\n",
    "# first, the data from static vars from df_static\n",
    "X = df_data.merge(df_static.set_index('icustay_id')[var_static], how='left', left_index=True, right_index=True)\n",
    "# next, add in the outcome: death in hospital\n",
    "X = X.merge(co.set_index('icustay_id')[[y_outcome_label]], left_index=True, right_index=True)\n",
    "\n",
    "# map above K-fold indices to this dataset\n",
    "X = X.merge(co.set_index('icustay_id')[['subject_id']], left_index=True, right_index=True)\n",
    "# get indices which map subject_ids in sid to the X dataframe\n",
    "idxMap = np.searchsorted(sid, X['subject_id'].values)\n",
    "# use these indices to map the k-fold integers\n",
    "idxK = idxK_sid[idxMap]\n",
    "# drop the subject_id column\n",
    "X.drop('subject_id',axis=1,inplace=True)\n",
    "\n",
    "# convert to numpy data (assumes target, death, is the last column)\n",
    "X = X.values\n",
    "y = X[:,-1]\n",
    "X = X[:,0:-1]\n",
    "X_header = [x for x in df_data.columns.values] + var_static\n",
    "\n",
    "mdl_val = dict()\n",
    "results_val = dict()\n",
    "pred_val = dict()\n",
    "tar_val = dict()\n",
    "\n",
    "for mdl in models:\n",
    "    print('=============== {} ==============='.format(mdl))\n",
    "    mdl_val[mdl] = list()\n",
    "    results_val[mdl] = list() # initialize list for scores\n",
    "    pred_val[mdl] = list()\n",
    "    tar_val[mdl] = list()\n",
    "\n",
    "    if mdl == 'xgb':\n",
    "        # no pre-processing of data necessary for xgb\n",
    "        estimator = Pipeline([(mdl, models[mdl])])\n",
    "\n",
    "    else:\n",
    "        estimator = Pipeline([(\"imputer\", Imputer(missing_values='NaN',\n",
    "                                          strategy=\"mean\",\n",
    "                                          axis=0)),\n",
    "                      (\"scaler\", StandardScaler()),\n",
    "                      (mdl, models[mdl])]) \n",
    "\n",
    "    for k in range(K):\n",
    "        # train the model using all but the kth fold\n",
    "        curr_mdl = estimator.fit(X[idxK != k, :],y[idxK != k])\n",
    "\n",
    "        # get prediction on this dataset\n",
    "        if mdl == 'lasso':\n",
    "            curr_prob = curr_mdl.predict(X[idxK == k, :])\n",
    "        else:\n",
    "            curr_prob = curr_mdl.predict_proba(X[idxK == k, :])\n",
    "            curr_prob = curr_prob[:,1]\n",
    "\n",
    "        pred_val[mdl].append(curr_prob)\n",
    "        tar_val[mdl].append(y[idxK == k])\n",
    "\n",
    "        # calculate score (AUROC)\n",
    "        curr_score = metrics.roc_auc_score(y[idxK == k], curr_prob)\n",
    "\n",
    "        # add score to list of scores\n",
    "        results_val[mdl].append(curr_score)\n",
    "\n",
    "        # save the current model\n",
    "        mdl_val[mdl].append(curr_mdl)\n",
    "\n",
    "        print('{} - Finished fold {} of {}. AUROC {:0.3f}.'.format(dt.datetime.now(), k+1, K, curr_score))\n",
    "        \n",
    "\n",
    "\n",
    "# print final results\n",
    "print('')\n",
    "print('StudyName,SampleSize',end='')\n",
    "for mdl in models:\n",
    "    print(',{}'.format(mdl),end='')\n",
    "print('')\n",
    "\n",
    "print( '{},{}'.format(current_study, X.shape[0] ), end='' )\n",
    "\n",
    "for i, mdl in enumerate(models):\n",
    "    print(',{:0.6f}'.format( np.mean(results_val[mdl]) ), end='')\n",
    "print('\\n')"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Baseline model 2: No care withdrawal patients\n",
    "\n",
    "Patients who choose to have their care withdrawn will receive palliative measures in the ICU. These patients show markedly different physiology than those undergoing full interventions and a model which synthesizes severity should not incorporate their data. Here we remove data for patients at the time of their withdrawal of care. If this is before the end of the first 24 hours of their ICU admission, we remove the patient entirely."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 28,
   "metadata": {
    "collapsed": false
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "===================================================\n",
      "========== BEGINNING baseline_withdrawal ==========\n",
      "===================================================\n",
      "Reducing sample size from 52085 to 38687 (74.33%).\n",
      "\n",
      "=============== xgb ===============\n",
      "2017-08-24 15:38:28.379026 - Finished fold 1 of 5. AUROC 0.880.\n",
      "2017-08-24 15:38:39.824625 - Finished fold 2 of 5. AUROC 0.888.\n",
      "2017-08-24 15:38:51.282528 - Finished fold 3 of 5. AUROC 0.887.\n",
      "2017-08-24 15:39:02.546569 - Finished fold 4 of 5. AUROC 0.886.\n",
      "2017-08-24 15:39:14.247252 - Finished fold 5 of 5. AUROC 0.897.\n",
      "=============== logreg ===============\n",
      "2017-08-24 15:39:15.617601 - Finished fold 1 of 5. AUROC 0.868.\n",
      "2017-08-24 15:39:17.084646 - Finished fold 2 of 5. AUROC 0.871.\n",
      "2017-08-24 15:39:18.699613 - Finished fold 3 of 5. AUROC 0.863.\n",
      "2017-08-24 15:39:20.303882 - Finished fold 4 of 5. AUROC 0.862.\n",
      "2017-08-24 15:39:21.799444 - Finished fold 5 of 5. AUROC 0.880.\n",
      "\n",
      "StudyName,SampleSize,xgb,logreg\n",
      "baseline_withdrawal,38687,0.887690,0.868978\n",
      "\n"
     ]
    }
   ],
   "source": [
    "CENSOR_FLAG = True\n",
    "current_study = 'baseline_withdrawal'\n",
    "\n",
    "print('====================={}==========='.format('='*len(current_study)))\n",
    "print('========== BEGINNING {} =========='.format(current_study))\n",
    "print('====================={}==========='.format('='*len(current_study)))\n",
    "\n",
    "# optionally remove patients who were DNR in first 24hrs\n",
    "if CENSOR_FLAG:\n",
    "    exclFcn = lambda x: x.loc[x['inclusion_stay_ge_24hr']& ( (x['censortime_hours'].isnull()) | (x['censortime_hours']>=24) ) ,'icustay_id'].values\n",
    "else:\n",
    "    exclFcn = lambda x: x.loc[x['inclusion_stay_ge_24hr']& ( (x['censortime_hours'].isnull()) | (x['censortime_hours']>=24) ) ,'icustay_id'].values\n",
    "    \n",
    "df_data = mp.get_design_matrix(df, time_dict, W=W, W_extra=W_extra)\n",
    "\n",
    "iid_keep = exclFcn(co)\n",
    "N_NEW=df_data.loc[iid_keep,:].shape[0]\n",
    "\n",
    "print('Reducing sample size from {} to {} ({:2.2f}%).'.format(\n",
    "        co.shape[0], N_NEW, N_NEW*100.0 / df_data.shape[0]))\n",
    "df_data = df_data.loc[iid_keep,:]\n",
    "print('')\n",
    "\n",
    "# load the data into a numpy array\n",
    "\n",
    "# first, the data from static vars from df_static\n",
    "X = df_data.merge(df_static.set_index('icustay_id')[var_static], how='left', left_index=True, right_index=True)\n",
    "# next, add in the outcome: death in hospital\n",
    "X = X.merge(co.set_index('icustay_id')[[y_outcome_label]], left_index=True, right_index=True)\n",
    "\n",
    "# map above K-fold indices to this dataset\n",
    "X = X.merge(co.set_index('icustay_id')[['subject_id']], left_index=True, right_index=True)\n",
    "# get indices which map subject_ids in sid to the X dataframe\n",
    "idxMap = np.searchsorted(sid, X['subject_id'].values)\n",
    "# use these indices to map the k-fold integers\n",
    "idxK = idxK_sid[idxMap]\n",
    "# drop the subject_id column\n",
    "X.drop('subject_id',axis=1,inplace=True)\n",
    "\n",
    "# convert to numpy data (assumes target, death, is the last column)\n",
    "X = X.values\n",
    "y = X[:,-1]\n",
    "X = X[:,0:-1]\n",
    "X_header = [x for x in df_data.columns.values] + var_static\n",
    "\n",
    "mdl_val = dict()\n",
    "results_val = dict()\n",
    "pred_val = dict()\n",
    "tar_val = dict()\n",
    "\n",
    "for mdl in models:\n",
    "    print('=============== {} ==============='.format(mdl))\n",
    "    mdl_val[mdl] = list()\n",
    "    results_val[mdl] = list() # initialize list for scores\n",
    "    pred_val[mdl] = list()\n",
    "    tar_val[mdl] = list()\n",
    "\n",
    "    if mdl == 'xgb':\n",
    "        # no pre-processing of data necessary for xgb\n",
    "        estimator = Pipeline([(mdl, models[mdl])])\n",
    "\n",
    "    else:\n",
    "        estimator = Pipeline([(\"imputer\", Imputer(missing_values='NaN',\n",
    "                                          strategy=\"mean\",\n",
    "                                          axis=0)),\n",
    "                      (\"scaler\", StandardScaler()),\n",
    "                      (mdl, models[mdl])]) \n",
    "\n",
    "    for k in range(K):\n",
    "        # train the model using all but the kth fold\n",
    "        curr_mdl = estimator.fit(X[idxK != k, :],y[idxK != k])\n",
    "\n",
    "        # get prediction on this dataset\n",
    "        if mdl == 'lasso':\n",
    "            curr_prob = curr_mdl.predict(X[idxK == k, :])\n",
    "        else:\n",
    "            curr_prob = curr_mdl.predict_proba(X[idxK == k, :])\n",
    "            curr_prob = curr_prob[:,1]\n",
    "\n",
    "        pred_val[mdl].append(curr_prob)\n",
    "        tar_val[mdl].append(y[idxK == k])\n",
    "\n",
    "        # calculate score (AUROC)\n",
    "        curr_score = metrics.roc_auc_score(y[idxK == k], curr_prob)\n",
    "\n",
    "        # add score to list of scores\n",
    "        results_val[mdl].append(curr_score)\n",
    "\n",
    "        # save the current model\n",
    "        mdl_val[mdl].append(curr_mdl)\n",
    "\n",
    "        print('{} - Finished fold {} of {}. AUROC {:0.3f}.'.format(dt.datetime.now(), k+1, K, curr_score))\n",
    "        \n",
    "\n",
    "\n",
    "# print final results\n",
    "print('')\n",
    "print('StudyName,SampleSize',end='')\n",
    "for mdl in models:\n",
    "    print(',{}'.format(mdl),end='')\n",
    "print('')\n",
    "\n",
    "print( '{},{}'.format(current_study, X.shape[0] ), end='' )\n",
    "\n",
    "for i, mdl in enumerate(models):\n",
    "    print(',{:0.6f}'.format( np.mean(results_val[mdl]) ), end='')\n",
    "\n",
    "print('\\n')"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 2",
   "language": "python",
   "name": "python2"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 2
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython2",
   "version": "2.7.12"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 0
}
